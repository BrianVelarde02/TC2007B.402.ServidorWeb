{"filter":false,"title":"ServicioAutenticacion.cs","tooltip":"/Backend/Servicios/ServicioAutenticacion.cs","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":3,"column":0},"end":{"row":4,"column":0},"action":"insert","lines":["using Backend.Modelos.Usuario;",""],"id":207}],[{"start":{"row":0,"column":0},"end":{"row":71,"column":1},"action":"remove","lines":["using Isopoh.Cryptography.Argon2;","using Microsoft.EntityFrameworkCore;","using Backend.Ayudantes;","using Backend.Modelos.Usuario;","","","namespace Backend.Servicios","{","    public interface IServicioAutenticacion","    {","        Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto);","    }","","    public class ServicioAutenticacion : IServicioAutenticacion","    {","        private readonly ApiDbContext _db;","        private readonly IServicioCifrado _cifrado;","","        public ServicioAutenticacion(ApiDbContext db, IServicioCifrado cifrado)","        {","            _db = db;","            _cifrado = cifrado;","        }","","        public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","","            var correoHash = HashAyudante.HashCorreo(dto.correo);","","            if (await _db.usuarios.AnyAsync(u => u.correo_hash == correoHash))","                throw new InvalidOperationException(\"El correo ya está registrado\");","","            var passwordHash = Argon2.Hash(dto.contrasena);","","            var usuario = new Usuarios","            {","                correo = _cifrado.Proteger(dto.correo),","                correo_hash = correoHash,","                hash_contrasena = passwordHash,","                nombre = _cifrado.Proteger(dto.nombre ?? \"\"),","                apellidos = _cifrado.Proteger(dto.apellidos ?? \"\"),","                telefono = _cifrado.Proteger(dto.telefono ?? \"\"),","                curp = _cifrado.Proteger(dto.curp ?? \"\"),","                direccion = _cifrado.Proteger(dto.direccion ?? \"\"),","                tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","                esta_activo = true,","                creado_en = DateTime.UtcNow","            };","","            _db.usuarios.Add(usuario);","            await _db.SaveChangesAsync();","","            return new UsuarioDto","            {","                id = usuario.id,","                correo = dto.correo,","                nombre = dto.nombre ?? \"\",","                apellidos = dto.apellidos ?? \"\",","                telefono = dto.telefono ?? \"\",","                curp = dto.curp ?? \"\",","                direccion = dto.direccion ?? \"\",","                tipo_usuario = usuario.tipo_usuario,","                esta_activo = usuario.esta_activo,","                creado_en = usuario.creado_en","            };","        }","    }","}"],"id":208},{"start":{"row":0,"column":0},"end":{"row":69,"column":0},"action":"insert","lines":["using Isopoh.Cryptography.Argon2;","using Microsoft.EntityFrameworkCore;","using Backend.Ayudantes;","using Backend.Modelos.Usuario;","","namespace Backend.Servicios","{","    public interface IServicioAutenticacion","    {","        Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto);","    }","","    public class ServicioAutenticacion : IServicioAutenticacion","    {","        private readonly ApiDbContext _db;","        private readonly IServicioCifrado _cifrado;","","        public ServicioAutenticacion(ApiDbContext db, IServicioCifrado cifrado)","        {","            _db = db;","            _cifrado = cifrado;","        }","","        public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","","            // Validación básica: correo único en base de datos","            if (await _db.Usuarios.AnyAsync(u => u.correo == _cifrado.Proteger(dto.correo)))","                throw new InvalidOperationException(\"El correo ya está registrado\");","","            var passwordHash = Argon2.Hash(dto.contrasena);","","            var usuario = new Usuario","            {","                correo = _cifrado.Proteger(dto.correo),","                hash_contrasena = passwordHash,","                nombre = _cifrado.Proteger(dto.nombre ?? \"\"),","                apellidos = _cifrado.Proteger(dto.apellidos ?? \"\"),","                telefono = _cifrado.Proteger(dto.telefono ?? \"\"),","                curp = _cifrado.Proteger(dto.curp ?? \"\"),","                direccion = _cifrado.Proteger(dto.direccion ?? \"\"),","                tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","                esta_activo = true,","                creado_en = DateTime.UtcNow","            };","","            _db.Usuarios.Add(usuario);","            await _db.SaveChangesAsync();","","            return new UsuarioDto","            {","                id = usuario.id,","                correo = dto.correo,","                nombre = dto.nombre ?? \"\",","                apellidos = dto.apellidos ?? \"\",","                telefono = dto.telefono ?? \"\",","                curp = dto.curp ?? \"\",","                direccion = dto.direccion ?? \"\",","                tipo_usuario = usuario.tipo_usuario,","                esta_activo = usuario.esta_activo,","                creado_en = usuario.creado_en","            };","        }","    }","}",""]}],[{"start":{"row":23,"column":8},"end":{"row":66,"column":9},"action":"remove","lines":["public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","","            // Validación básica: correo único en base de datos","            if (await _db.Usuarios.AnyAsync(u => u.correo == _cifrado.Proteger(dto.correo)))","                throw new InvalidOperationException(\"El correo ya está registrado\");","","            var passwordHash = Argon2.Hash(dto.contrasena);","","            var usuario = new Usuario","            {","                correo = _cifrado.Proteger(dto.correo),","                hash_contrasena = passwordHash,","                nombre = _cifrado.Proteger(dto.nombre ?? \"\"),","                apellidos = _cifrado.Proteger(dto.apellidos ?? \"\"),","                telefono = _cifrado.Proteger(dto.telefono ?? \"\"),","                curp = _cifrado.Proteger(dto.curp ?? \"\"),","                direccion = _cifrado.Proteger(dto.direccion ?? \"\"),","                tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","                esta_activo = true,","                creado_en = DateTime.UtcNow","            };","","            _db.Usuarios.Add(usuario);","            await _db.SaveChangesAsync();","","            return new UsuarioDto","            {","                id = usuario.id,","                correo = dto.correo,","                nombre = dto.nombre ?? \"\",","                apellidos = dto.apellidos ?? \"\",","                telefono = dto.telefono ?? \"\",","                curp = dto.curp ?? \"\",","                direccion = dto.direccion ?? \"\",","                tipo_usuario = usuario.tipo_usuario,","                esta_activo = usuario.esta_activo,","                creado_en = usuario.creado_en","            };","        }"],"id":209},{"start":{"row":23,"column":8},"end":{"row":67,"column":0},"action":"insert","lines":["public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto)","{","    if (string.IsNullOrWhiteSpace(dto.correo))","        throw new ArgumentException(\"Correo es obligatorio\");","    if (string.IsNullOrWhiteSpace(dto.contrasena))","        throw new ArgumentException(\"Contraseña es obligatoria\");","","    // Validación de correo único","    if (await _db.Usuarios.AnyAsync(u => u.correo == _cifrado.Proteger(dto.correo)))","        throw new InvalidOperationException(\"El correo ya está registrado\");","","    var passwordHash = Argon2.Hash(dto.contrasena);","","    var usuario = new Usuario","    {","        correo = _cifrado.Proteger(dto.correo),","        hash_contrasena = passwordHash,","        nombre = _cifrado.Proteger(dto.nombre),","        apellidos = _cifrado.Proteger(dto.apellidos),","        telefono = _cifrado.Proteger(dto.telefono ?? \"\"),","        curp = _cifrado.Proteger(dto.curp ?? \"\"),","        direccion = _cifrado.Proteger(dto.direccion ?? \"\"),","        tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","        esta_activo = true,","        creado_en = DateTime.UtcNow","    };","","    _db.Usuarios.Add(usuario);","    await _db.SaveChangesAsync();","","    return new UsuarioDto","    {","        Id = usuario.id,","        Correo = dto.correo,","        Nombre = dto.nombre,","        Apellidos = dto.apellidos,","        Telefono = dto.telefono,","        Curp = dto.curp,","        Direccion = dto.direccion,","        TipoUsuario = usuario.tipo_usuario,","        EstaActivo = usuario.esta_activo,","        CreadoEn = usuario.creado_en","    };","}",""]}],[{"start":{"row":24,"column":0},"end":{"row":24,"column":4},"action":"insert","lines":["    "],"id":210},{"start":{"row":25,"column":0},"end":{"row":25,"column":4},"action":"insert","lines":["    "]},{"start":{"row":26,"column":0},"end":{"row":26,"column":4},"action":"insert","lines":["    "]},{"start":{"row":27,"column":0},"end":{"row":27,"column":4},"action":"insert","lines":["    "]},{"start":{"row":28,"column":0},"end":{"row":28,"column":4},"action":"insert","lines":["    "]},{"start":{"row":29,"column":0},"end":{"row":29,"column":4},"action":"insert","lines":["    "]},{"start":{"row":30,"column":0},"end":{"row":30,"column":4},"action":"insert","lines":["    "]},{"start":{"row":31,"column":0},"end":{"row":31,"column":4},"action":"insert","lines":["    "]},{"start":{"row":32,"column":0},"end":{"row":32,"column":4},"action":"insert","lines":["    "]},{"start":{"row":33,"column":0},"end":{"row":33,"column":4},"action":"insert","lines":["    "]},{"start":{"row":34,"column":0},"end":{"row":34,"column":4},"action":"insert","lines":["    "]},{"start":{"row":35,"column":0},"end":{"row":35,"column":4},"action":"insert","lines":["    "]},{"start":{"row":36,"column":0},"end":{"row":36,"column":4},"action":"insert","lines":["    "]},{"start":{"row":37,"column":0},"end":{"row":37,"column":4},"action":"insert","lines":["    "]},{"start":{"row":38,"column":0},"end":{"row":38,"column":4},"action":"insert","lines":["    "]},{"start":{"row":39,"column":0},"end":{"row":39,"column":4},"action":"insert","lines":["    "]},{"start":{"row":40,"column":0},"end":{"row":40,"column":4},"action":"insert","lines":["    "]},{"start":{"row":41,"column":0},"end":{"row":41,"column":4},"action":"insert","lines":["    "]},{"start":{"row":42,"column":0},"end":{"row":42,"column":4},"action":"insert","lines":["    "]},{"start":{"row":43,"column":0},"end":{"row":43,"column":4},"action":"insert","lines":["    "]},{"start":{"row":44,"column":0},"end":{"row":44,"column":4},"action":"insert","lines":["    "]},{"start":{"row":45,"column":0},"end":{"row":45,"column":4},"action":"insert","lines":["    "]},{"start":{"row":46,"column":0},"end":{"row":46,"column":4},"action":"insert","lines":["    "]},{"start":{"row":47,"column":0},"end":{"row":47,"column":4},"action":"insert","lines":["    "]},{"start":{"row":48,"column":0},"end":{"row":48,"column":4},"action":"insert","lines":["    "]},{"start":{"row":49,"column":0},"end":{"row":49,"column":4},"action":"insert","lines":["    "]},{"start":{"row":50,"column":0},"end":{"row":50,"column":4},"action":"insert","lines":["    "]},{"start":{"row":51,"column":0},"end":{"row":51,"column":4},"action":"insert","lines":["    "]},{"start":{"row":52,"column":0},"end":{"row":52,"column":4},"action":"insert","lines":["    "]},{"start":{"row":53,"column":0},"end":{"row":53,"column":4},"action":"insert","lines":["    "]},{"start":{"row":54,"column":0},"end":{"row":54,"column":4},"action":"insert","lines":["    "]},{"start":{"row":55,"column":0},"end":{"row":55,"column":4},"action":"insert","lines":["    "]},{"start":{"row":56,"column":0},"end":{"row":56,"column":4},"action":"insert","lines":["    "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":4},"action":"insert","lines":["    "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":4},"action":"insert","lines":["    "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":4},"action":"insert","lines":["    "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":4},"action":"insert","lines":["    "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":4},"action":"insert","lines":["    "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":4},"action":"insert","lines":["    "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":4},"action":"insert","lines":["    "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":4},"action":"insert","lines":["    "]},{"start":{"row":65,"column":0},"end":{"row":65,"column":4},"action":"insert","lines":["    "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":24,"column":0},"end":{"row":24,"column":4},"action":"insert","lines":["    "],"id":211},{"start":{"row":25,"column":0},"end":{"row":25,"column":4},"action":"insert","lines":["    "]},{"start":{"row":26,"column":0},"end":{"row":26,"column":4},"action":"insert","lines":["    "]},{"start":{"row":27,"column":0},"end":{"row":27,"column":4},"action":"insert","lines":["    "]},{"start":{"row":28,"column":0},"end":{"row":28,"column":4},"action":"insert","lines":["    "]},{"start":{"row":29,"column":0},"end":{"row":29,"column":4},"action":"insert","lines":["    "]},{"start":{"row":30,"column":0},"end":{"row":30,"column":4},"action":"insert","lines":["    "]},{"start":{"row":31,"column":0},"end":{"row":31,"column":4},"action":"insert","lines":["    "]},{"start":{"row":32,"column":0},"end":{"row":32,"column":4},"action":"insert","lines":["    "]},{"start":{"row":33,"column":0},"end":{"row":33,"column":4},"action":"insert","lines":["    "]},{"start":{"row":34,"column":0},"end":{"row":34,"column":4},"action":"insert","lines":["    "]},{"start":{"row":35,"column":0},"end":{"row":35,"column":4},"action":"insert","lines":["    "]},{"start":{"row":36,"column":0},"end":{"row":36,"column":4},"action":"insert","lines":["    "]},{"start":{"row":37,"column":0},"end":{"row":37,"column":4},"action":"insert","lines":["    "]},{"start":{"row":38,"column":0},"end":{"row":38,"column":4},"action":"insert","lines":["    "]},{"start":{"row":39,"column":0},"end":{"row":39,"column":4},"action":"insert","lines":["    "]},{"start":{"row":40,"column":0},"end":{"row":40,"column":4},"action":"insert","lines":["    "]},{"start":{"row":41,"column":0},"end":{"row":41,"column":4},"action":"insert","lines":["    "]},{"start":{"row":42,"column":0},"end":{"row":42,"column":4},"action":"insert","lines":["    "]},{"start":{"row":43,"column":0},"end":{"row":43,"column":4},"action":"insert","lines":["    "]},{"start":{"row":44,"column":0},"end":{"row":44,"column":4},"action":"insert","lines":["    "]},{"start":{"row":45,"column":0},"end":{"row":45,"column":4},"action":"insert","lines":["    "]},{"start":{"row":46,"column":0},"end":{"row":46,"column":4},"action":"insert","lines":["    "]},{"start":{"row":47,"column":0},"end":{"row":47,"column":4},"action":"insert","lines":["    "]},{"start":{"row":48,"column":0},"end":{"row":48,"column":4},"action":"insert","lines":["    "]},{"start":{"row":49,"column":0},"end":{"row":49,"column":4},"action":"insert","lines":["    "]},{"start":{"row":50,"column":0},"end":{"row":50,"column":4},"action":"insert","lines":["    "]},{"start":{"row":51,"column":0},"end":{"row":51,"column":4},"action":"insert","lines":["    "]},{"start":{"row":52,"column":0},"end":{"row":52,"column":4},"action":"insert","lines":["    "]},{"start":{"row":53,"column":0},"end":{"row":53,"column":4},"action":"insert","lines":["    "]},{"start":{"row":54,"column":0},"end":{"row":54,"column":4},"action":"insert","lines":["    "]},{"start":{"row":55,"column":0},"end":{"row":55,"column":4},"action":"insert","lines":["    "]},{"start":{"row":56,"column":0},"end":{"row":56,"column":4},"action":"insert","lines":["    "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":4},"action":"insert","lines":["    "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":4},"action":"insert","lines":["    "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":4},"action":"insert","lines":["    "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":4},"action":"insert","lines":["    "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":4},"action":"insert","lines":["    "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":4},"action":"insert","lines":["    "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":4},"action":"insert","lines":["    "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":4},"action":"insert","lines":["    "]},{"start":{"row":65,"column":0},"end":{"row":65,"column":4},"action":"insert","lines":["    "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":36,"column":30},"end":{"row":36,"column":37},"action":"remove","lines":["Usuario"],"id":212}],[{"start":{"row":36,"column":30},"end":{"row":36,"column":31},"action":"insert","lines":["u"],"id":213}],[{"start":{"row":36,"column":30},"end":{"row":36,"column":31},"action":"remove","lines":["u"],"id":214},{"start":{"row":36,"column":30},"end":{"row":36,"column":38},"action":"insert","lines":["usuarios"]}],[{"start":{"row":31,"column":26},"end":{"row":31,"column":27},"action":"remove","lines":["U"],"id":215}],[{"start":{"row":31,"column":26},"end":{"row":31,"column":27},"action":"insert","lines":["u"],"id":216}],[{"start":{"row":50,"column":16},"end":{"row":50,"column":17},"action":"remove","lines":["U"],"id":217}],[{"start":{"row":50,"column":16},"end":{"row":50,"column":17},"action":"insert","lines":["u"],"id":218}],[{"start":{"row":9,"column":61},"end":{"row":10,"column":0},"action":"insert","lines":["",""],"id":219},{"start":{"row":10,"column":0},"end":{"row":10,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":10,"column":8},"end":{"row":10,"column":57},"action":"insert","lines":["Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto);"],"id":220}],[{"start":{"row":67,"column":9},"end":{"row":68,"column":0},"action":"insert","lines":["",""],"id":221},{"start":{"row":68,"column":0},"end":{"row":68,"column":8},"action":"insert","lines":["        "]},{"start":{"row":68,"column":8},"end":{"row":69,"column":0},"action":"insert","lines":["",""]},{"start":{"row":69,"column":0},"end":{"row":69,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":69,"column":8},"end":{"row":103,"column":0},"action":"insert","lines":["public async Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto)","{","    if (string.IsNullOrWhiteSpace(dto.Correo))","        throw new ArgumentException(\"Correo es obligatorio\");","    if (string.IsNullOrWhiteSpace(dto.Contrasena))","        throw new ArgumentException(\"Contraseña es obligatoria\");","","    // El correo se guarda cifrado en BD, por eso lo protegemos igual","    var correoCifrado = _cifrado.Proteger(dto.Correo);","","    var usuario = await _db.usuarios.FirstOrDefaultAsync(u => u.correo == correoCifrado);","","    if (usuario == null)","        throw new InvalidOperationException(\"Usuario no encontrado\");","","    // Validar contraseña con Argon2","    if (!Argon2.Verify(usuario.hash_contrasena, dto.Contrasena))","        throw new ArgumentException(\"Contraseña incorrecta\");","","    // Construir el DTO de salida, devolviendo valores desencriptados","    return new UsuarioDto","    {","        Id = usuario.id,","        Correo = dto.Correo, // Lo devolvemos plano, no cifrado","        Nombre = _cifrado.Desproteger(usuario.nombre),","        Apellidos = _cifrado.Desproteger(usuario.apellidos),","        Telefono = _cifrado.Desproteger(usuario.telefono),","        Curp = _cifrado.Desproteger(usuario.curp),","        Direccion = _cifrado.Desproteger(usuario.direccion),","        TipoUsuario = usuario.tipo_usuario,","        EstaActivo = usuario.esta_activo,","        CreadoEn = usuario.creado_en","    };","}",""],"id":222}],[{"start":{"row":70,"column":0},"end":{"row":70,"column":4},"action":"insert","lines":["    "],"id":223},{"start":{"row":71,"column":0},"end":{"row":71,"column":4},"action":"insert","lines":["    "]},{"start":{"row":72,"column":0},"end":{"row":72,"column":4},"action":"insert","lines":["    "]},{"start":{"row":73,"column":0},"end":{"row":73,"column":4},"action":"insert","lines":["    "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":4},"action":"insert","lines":["    "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"insert","lines":["    "]},{"start":{"row":76,"column":0},"end":{"row":76,"column":4},"action":"insert","lines":["    "]},{"start":{"row":77,"column":0},"end":{"row":77,"column":4},"action":"insert","lines":["    "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":4},"action":"insert","lines":["    "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":4},"action":"insert","lines":["    "]},{"start":{"row":80,"column":0},"end":{"row":80,"column":4},"action":"insert","lines":["    "]},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":4},"action":"insert","lines":["    "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":4},"action":"insert","lines":["    "]},{"start":{"row":84,"column":0},"end":{"row":84,"column":4},"action":"insert","lines":["    "]},{"start":{"row":85,"column":0},"end":{"row":85,"column":4},"action":"insert","lines":["    "]},{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "]},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]},{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "]},{"start":{"row":89,"column":0},"end":{"row":89,"column":4},"action":"insert","lines":["    "]},{"start":{"row":90,"column":0},"end":{"row":90,"column":4},"action":"insert","lines":["    "]},{"start":{"row":91,"column":0},"end":{"row":91,"column":4},"action":"insert","lines":["    "]},{"start":{"row":92,"column":0},"end":{"row":92,"column":4},"action":"insert","lines":["    "]},{"start":{"row":93,"column":0},"end":{"row":93,"column":4},"action":"insert","lines":["    "]},{"start":{"row":94,"column":0},"end":{"row":94,"column":4},"action":"insert","lines":["    "]},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]},{"start":{"row":96,"column":0},"end":{"row":96,"column":4},"action":"insert","lines":["    "]},{"start":{"row":97,"column":0},"end":{"row":97,"column":4},"action":"insert","lines":["    "]},{"start":{"row":98,"column":0},"end":{"row":98,"column":4},"action":"insert","lines":["    "]},{"start":{"row":99,"column":0},"end":{"row":99,"column":4},"action":"insert","lines":["    "]},{"start":{"row":100,"column":0},"end":{"row":100,"column":4},"action":"insert","lines":["    "]},{"start":{"row":101,"column":0},"end":{"row":101,"column":4},"action":"insert","lines":["    "]},{"start":{"row":102,"column":0},"end":{"row":102,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":102,"column":5},"end":{"row":103,"column":0},"action":"remove","lines":["",""],"id":224}],[{"start":{"row":102,"column":5},"end":{"row":103,"column":0},"action":"remove","lines":["",""],"id":225}],[{"start":{"row":70,"column":0},"end":{"row":70,"column":4},"action":"insert","lines":["    "],"id":226},{"start":{"row":71,"column":0},"end":{"row":71,"column":4},"action":"insert","lines":["    "]},{"start":{"row":72,"column":0},"end":{"row":72,"column":4},"action":"insert","lines":["    "]},{"start":{"row":73,"column":0},"end":{"row":73,"column":4},"action":"insert","lines":["    "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":4},"action":"insert","lines":["    "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"insert","lines":["    "]},{"start":{"row":76,"column":0},"end":{"row":76,"column":4},"action":"insert","lines":["    "]},{"start":{"row":77,"column":0},"end":{"row":77,"column":4},"action":"insert","lines":["    "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":4},"action":"insert","lines":["    "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":4},"action":"insert","lines":["    "]},{"start":{"row":80,"column":0},"end":{"row":80,"column":4},"action":"insert","lines":["    "]},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":4},"action":"insert","lines":["    "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":4},"action":"insert","lines":["    "]},{"start":{"row":84,"column":0},"end":{"row":84,"column":4},"action":"insert","lines":["    "]},{"start":{"row":85,"column":0},"end":{"row":85,"column":4},"action":"insert","lines":["    "]},{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "]},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]},{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "]},{"start":{"row":89,"column":0},"end":{"row":89,"column":4},"action":"insert","lines":["    "]},{"start":{"row":90,"column":0},"end":{"row":90,"column":4},"action":"insert","lines":["    "]},{"start":{"row":91,"column":0},"end":{"row":91,"column":4},"action":"insert","lines":["    "]},{"start":{"row":92,"column":0},"end":{"row":92,"column":4},"action":"insert","lines":["    "]},{"start":{"row":93,"column":0},"end":{"row":93,"column":4},"action":"insert","lines":["    "]},{"start":{"row":94,"column":0},"end":{"row":94,"column":4},"action":"insert","lines":["    "]},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]},{"start":{"row":96,"column":0},"end":{"row":96,"column":4},"action":"insert","lines":["    "]},{"start":{"row":97,"column":0},"end":{"row":97,"column":4},"action":"insert","lines":["    "]},{"start":{"row":98,"column":0},"end":{"row":98,"column":4},"action":"insert","lines":["    "]},{"start":{"row":99,"column":0},"end":{"row":99,"column":4},"action":"insert","lines":["    "]},{"start":{"row":100,"column":0},"end":{"row":100,"column":4},"action":"insert","lines":["    "]},{"start":{"row":101,"column":0},"end":{"row":101,"column":4},"action":"insert","lines":["    "]},{"start":{"row":102,"column":0},"end":{"row":102,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":69,"column":8},"end":{"row":102,"column":9},"action":"remove","lines":["public async Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.Correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.Contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","        ","            // El correo se guarda cifrado en BD, por eso lo protegemos igual","            var correoCifrado = _cifrado.Proteger(dto.Correo);","        ","            var usuario = await _db.usuarios.FirstOrDefaultAsync(u => u.correo == correoCifrado);","        ","            if (usuario == null)","                throw new InvalidOperationException(\"Usuario no encontrado\");","        ","            // Validar contraseña con Argon2","            if (!Argon2.Verify(usuario.hash_contrasena, dto.Contrasena))","                throw new ArgumentException(\"Contraseña incorrecta\");","        ","            // Construir el DTO de salida, devolviendo valores desencriptados","            return new UsuarioDto","            {","                Id = usuario.id,","                Correo = dto.Correo, // Lo devolvemos plano, no cifrado","                Nombre = _cifrado.Desproteger(usuario.nombre),","                Apellidos = _cifrado.Desproteger(usuario.apellidos),","                Telefono = _cifrado.Desproteger(usuario.telefono),","                Curp = _cifrado.Desproteger(usuario.curp),","                Direccion = _cifrado.Desproteger(usuario.direccion),","                TipoUsuario = usuario.tipo_usuario,","                EstaActivo = usuario.esta_activo,","                CreadoEn = usuario.creado_en","            };","        }"],"id":227}],[{"start":{"row":69,"column":8},"end":{"row":101,"column":0},"action":"insert","lines":["public async Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto)","{","    if (string.IsNullOrWhiteSpace(dto.Correo))","        throw new ArgumentException(\"Correo es obligatorio\");","    if (string.IsNullOrWhiteSpace(dto.Contrasena))","        throw new ArgumentException(\"Contraseña es obligatoria\");","","    // Buscar usuario por correo en texto plano","    var usuario = await _db.usuarios.FirstOrDefaultAsync(u => u.correo == dto.Correo);","","    if (usuario == null)","        throw new InvalidOperationException(\"Usuario no encontrado\");","","    // Verificar contraseña","    if (!Argon2.Verify(usuario.hash_contrasena, dto.Contrasena))","        throw new ArgumentException(\"Contraseña incorrecta\");","","    // Retornar DTO (desencriptando solo los campos sensibles)","    return new UsuarioDto","    {","        Id = usuario.id,","        Correo = usuario.correo, // texto plano","        Nombre = _cifrado.Desproteger(usuario.nombre),","        Apellidos = _cifrado.Desproteger(usuario.apellidos),","        Telefono = _cifrado.Desproteger(usuario.telefono),","        Curp = _cifrado.Desproteger(usuario.curp),","        Direccion = _cifrado.Desproteger(usuario.direccion),","        TipoUsuario = string.IsNullOrWhiteSpace(usuario.tipo_usuario) ? \"JOVEN\" : usuario.tipo_usuario,","        EstaActivo = usuario.esta_activo,","        CreadoEn = usuario.creado_en","    };","}",""],"id":228}],[{"start":{"row":70,"column":0},"end":{"row":70,"column":4},"action":"insert","lines":["    "],"id":229},{"start":{"row":71,"column":0},"end":{"row":71,"column":4},"action":"insert","lines":["    "]},{"start":{"row":72,"column":0},"end":{"row":72,"column":4},"action":"insert","lines":["    "]},{"start":{"row":73,"column":0},"end":{"row":73,"column":4},"action":"insert","lines":["    "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":4},"action":"insert","lines":["    "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"insert","lines":["    "]},{"start":{"row":76,"column":0},"end":{"row":76,"column":4},"action":"insert","lines":["    "]},{"start":{"row":77,"column":0},"end":{"row":77,"column":4},"action":"insert","lines":["    "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":4},"action":"insert","lines":["    "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":4},"action":"insert","lines":["    "]},{"start":{"row":80,"column":0},"end":{"row":80,"column":4},"action":"insert","lines":["    "]},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":4},"action":"insert","lines":["    "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":4},"action":"insert","lines":["    "]},{"start":{"row":84,"column":0},"end":{"row":84,"column":4},"action":"insert","lines":["    "]},{"start":{"row":85,"column":0},"end":{"row":85,"column":4},"action":"insert","lines":["    "]},{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "]},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]},{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "]},{"start":{"row":89,"column":0},"end":{"row":89,"column":4},"action":"insert","lines":["    "]},{"start":{"row":90,"column":0},"end":{"row":90,"column":4},"action":"insert","lines":["    "]},{"start":{"row":91,"column":0},"end":{"row":91,"column":4},"action":"insert","lines":["    "]},{"start":{"row":92,"column":0},"end":{"row":92,"column":4},"action":"insert","lines":["    "]},{"start":{"row":93,"column":0},"end":{"row":93,"column":4},"action":"insert","lines":["    "]},{"start":{"row":94,"column":0},"end":{"row":94,"column":4},"action":"insert","lines":["    "]},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]},{"start":{"row":96,"column":0},"end":{"row":96,"column":4},"action":"insert","lines":["    "]},{"start":{"row":97,"column":0},"end":{"row":97,"column":4},"action":"insert","lines":["    "]},{"start":{"row":98,"column":0},"end":{"row":98,"column":4},"action":"insert","lines":["    "]},{"start":{"row":99,"column":0},"end":{"row":99,"column":4},"action":"insert","lines":["    "]},{"start":{"row":100,"column":0},"end":{"row":100,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":70,"column":0},"end":{"row":70,"column":4},"action":"insert","lines":["    "],"id":230},{"start":{"row":71,"column":0},"end":{"row":71,"column":4},"action":"insert","lines":["    "]},{"start":{"row":72,"column":0},"end":{"row":72,"column":4},"action":"insert","lines":["    "]},{"start":{"row":73,"column":0},"end":{"row":73,"column":4},"action":"insert","lines":["    "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":4},"action":"insert","lines":["    "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"insert","lines":["    "]},{"start":{"row":76,"column":0},"end":{"row":76,"column":4},"action":"insert","lines":["    "]},{"start":{"row":77,"column":0},"end":{"row":77,"column":4},"action":"insert","lines":["    "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":4},"action":"insert","lines":["    "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":4},"action":"insert","lines":["    "]},{"start":{"row":80,"column":0},"end":{"row":80,"column":4},"action":"insert","lines":["    "]},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":4},"action":"insert","lines":["    "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":4},"action":"insert","lines":["    "]},{"start":{"row":84,"column":0},"end":{"row":84,"column":4},"action":"insert","lines":["    "]},{"start":{"row":85,"column":0},"end":{"row":85,"column":4},"action":"insert","lines":["    "]},{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "]},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]},{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "]},{"start":{"row":89,"column":0},"end":{"row":89,"column":4},"action":"insert","lines":["    "]},{"start":{"row":90,"column":0},"end":{"row":90,"column":4},"action":"insert","lines":["    "]},{"start":{"row":91,"column":0},"end":{"row":91,"column":4},"action":"insert","lines":["    "]},{"start":{"row":92,"column":0},"end":{"row":92,"column":4},"action":"insert","lines":["    "]},{"start":{"row":93,"column":0},"end":{"row":93,"column":4},"action":"insert","lines":["    "]},{"start":{"row":94,"column":0},"end":{"row":94,"column":4},"action":"insert","lines":["    "]},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]},{"start":{"row":96,"column":0},"end":{"row":96,"column":4},"action":"insert","lines":["    "]},{"start":{"row":97,"column":0},"end":{"row":97,"column":4},"action":"insert","lines":["    "]},{"start":{"row":98,"column":0},"end":{"row":98,"column":4},"action":"insert","lines":["    "]},{"start":{"row":99,"column":0},"end":{"row":99,"column":4},"action":"insert","lines":["    "]},{"start":{"row":100,"column":0},"end":{"row":100,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":0,"column":0},"end":{"row":105,"column":0},"action":"remove","lines":["using Isopoh.Cryptography.Argon2;","using Microsoft.EntityFrameworkCore;","using Backend.Ayudantes;","using Backend.Modelos.Usuario;","","namespace Backend.Servicios","{","    public interface IServicioAutenticacion","    {","        Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto);","        Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto);","    }","","    public class ServicioAutenticacion : IServicioAutenticacion","    {","        private readonly ApiDbContext _db;","        private readonly IServicioCifrado _cifrado;","","        public ServicioAutenticacion(ApiDbContext db, IServicioCifrado cifrado)","        {","            _db = db;","            _cifrado = cifrado;","        }","","        public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","        ","            // Validación de correo único","            if (await _db.usuarios.AnyAsync(u => u.correo == _cifrado.Proteger(dto.correo)))","                throw new InvalidOperationException(\"El correo ya está registrado\");","        ","            var passwordHash = Argon2.Hash(dto.contrasena);","        ","            var usuario = new usuarios","            {","                correo = _cifrado.Proteger(dto.correo),","                hash_contrasena = passwordHash,","                nombre = _cifrado.Proteger(dto.nombre),","                apellidos = _cifrado.Proteger(dto.apellidos),","                telefono = _cifrado.Proteger(dto.telefono ?? \"\"),","                curp = _cifrado.Proteger(dto.curp ?? \"\"),","                direccion = _cifrado.Proteger(dto.direccion ?? \"\"),","                tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","                esta_activo = true,","                creado_en = DateTime.UtcNow","            };","        ","            _db.usuarios.Add(usuario);","            await _db.SaveChangesAsync();","        ","            return new UsuarioDto","            {","                Id = usuario.id,","                Correo = dto.correo,","                Nombre = dto.nombre,","                Apellidos = dto.apellidos,","                Telefono = dto.telefono,","                Curp = dto.curp,","                Direccion = dto.direccion,","                TipoUsuario = usuario.tipo_usuario,","                EstaActivo = usuario.esta_activo,","                CreadoEn = usuario.creado_en","            };","        }","        ","        public async Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.Correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.Contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","        ","            // Buscar usuario por correo en texto plano","            var usuario = await _db.usuarios.FirstOrDefaultAsync(u => u.correo == dto.Correo);","        ","            if (usuario == null)","                throw new InvalidOperationException(\"Usuario no encontrado\");","        ","            // Verificar contraseña","            if (!Argon2.Verify(usuario.hash_contrasena, dto.Contrasena))","                throw new ArgumentException(\"Contraseña incorrecta\");","        ","            // Retornar DTO (desencriptando solo los campos sensibles)","            return new UsuarioDto","            {","                Id = usuario.id,","                Correo = usuario.correo, // texto plano","                Nombre = _cifrado.Desproteger(usuario.nombre),","                Apellidos = _cifrado.Desproteger(usuario.apellidos),","                Telefono = _cifrado.Desproteger(usuario.telefono),","                Curp = _cifrado.Desproteger(usuario.curp),","                Direccion = _cifrado.Desproteger(usuario.direccion),","                TipoUsuario = string.IsNullOrWhiteSpace(usuario.tipo_usuario) ? \"JOVEN\" : usuario.tipo_usuario,","                EstaActivo = usuario.esta_activo,","                CreadoEn = usuario.creado_en","            };","        }","","    }","}","",""],"id":231},{"start":{"row":0,"column":0},"end":{"row":137,"column":0},"action":"insert","lines":["using Isopoh.Cryptography.Argon2;","using Microsoft.AspNetCore.DataProtection;","using Microsoft.EntityFrameworkCore;","using Backend.Modelos.Usuario;","","namespace Backend.Servicios","{","    public interface IServicioAutenticacion","    {","        Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto);","        Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto);","        Task<List<UsuarioDto>> ObtenerUsuariosAsync();","        Task<UsuarioDto?> ObtenerUsuarioPorIdAsync(int id);","    }","","    public class ServicioAutenticacion : IServicioAutenticacion","    {","        private readonly ApiDbContext _db;","        private readonly IDataProtector _protector;","","        public ServicioAutenticacion(ApiDbContext db, IDataProtectionProvider provider)","        {","            _db = db;","            _protector = provider.CreateProtector(\"UserData\");","        }","","        private string SafeUnprotect(string encrypted)","        {","            if (string.IsNullOrEmpty(encrypted)) return encrypted;","            try { return _protector.Unprotect(encrypted); } ","            catch { return encrypted; }","        }","","        public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.correo)) throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.contrasena)) throw new ArgumentException(\"Contraseña es obligatoria\");","","            if (await _db.usuarios.AnyAsync(u => SafeUnprotect(u.correo) == dto.correo))","                throw new InvalidOperationException(\"El correo ya está registrado\");","","            var passwordHash = Argon2.Hash(dto.contrasena);","","            var user = new usuarios","            {","                correo = _protector.Protect(dto.correo),","                hash_contrasena = passwordHash,","                nombre = _protector.Protect(dto.nombre),","                apellidos = _protector.Protect(dto.apellidos ?? \"\"),","                telefono = _protector.Protect(dto.telefono ?? \"\"),","                curp = _protector.Protect(dto.curp ?? \"\"),","                direccion = _protector.Protect(dto.direccion ?? \"\"),","                tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","                esta_activo = true,","                creado_en = DateTime.UtcNow","            };","","            _db.usuarios.Add(user);","            await _db.SaveChangesAsync();","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = dto.correo,","                Nombre = dto.nombre,","                Apellidos = dto.apellidos ?? \"\",","                Telefono = dto.telefono ?? \"\",","                Curp = dto.curp ?? \"\",","                Direccion = dto.direccion ?? \"\",","                TipoUsuario = user.tipo_usuario,","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","","        public async Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto)","        {","            var usuarios = await _db.usuarios.ToListAsync();","            var user = usuarios.FirstOrDefault(u => SafeUnprotect(u.correo).Equals(dto.Correo, StringComparison.OrdinalIgnoreCase));","","            if (user == null) throw new InvalidOperationException(\"Usuario no encontrado\");","            if (!Argon2.Verify(user.hash_contrasena, dto.Contrasena)) throw new ArgumentException(\"Contraseña incorrecta\");","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = SafeUnprotect(user.correo),","                Nombre = SafeUnprotect(user.nombre),","                Apellidos = SafeUnprotect(user.apellidos),","                Telefono = SafeUnprotect(user.telefono),","                Curp = SafeUnprotect(user.curp),","                Direccion = SafeUnprotect(user.direccion),","                TipoUsuario = user.tipo_usuario ?? \"JOVEN\",","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","","        public async Task<List<UsuarioDto>> ObtenerUsuariosAsync()","        {","            var usuarios = await _db.usuarios.ToListAsync();","            return usuarios.Select(u => new UsuarioDto","            {","                Id = u.id,","                Correo = SafeUnprotect(u.correo),","                Nombre = SafeUnprotect(u.nombre),","                Apellidos = SafeUnprotect(u.apellidos),","                Telefono = SafeUnprotect(u.telefono),","                Curp = SafeUnprotect(u.curp),","                Direccion = SafeUnprotect(u.direccion),","                TipoUsuario = u.tipo_usuario ?? \"JOVEN\",","                EstaActivo = u.esta_activo,","                CreadoEn = u.creado_en","            }).ToList();","        }","","        public async Task<UsuarioDto?> ObtenerUsuarioPorIdAsync(int id)","        {","            var user = await _db.usuarios.FindAsync(id);","            if (user == null) return null;","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = SafeUnprotect(user.correo),","                Nombre = SafeUnprotect(user.nombre),","                Apellidos = SafeUnprotect(user.apellidos),","                Telefono = SafeUnprotect(user.telefono),","                Curp = SafeUnprotect(user.curp),","                Direccion = SafeUnprotect(user.direccion),","                TipoUsuario = user.tipo_usuario ?? \"JOVEN\",","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","    }","}",""]}],[{"start":{"row":37,"column":0},"end":{"row":37,"column":4},"action":"insert","lines":["    "],"id":232}],[{"start":{"row":37,"column":4},"end":{"row":37,"column":8},"action":"insert","lines":["    "],"id":233}],[{"start":{"row":37,"column":8},"end":{"row":37,"column":12},"action":"insert","lines":["    "],"id":234}],[{"start":{"row":0,"column":0},"end":{"row":137,"column":0},"action":"remove","lines":["using Isopoh.Cryptography.Argon2;","using Microsoft.AspNetCore.DataProtection;","using Microsoft.EntityFrameworkCore;","using Backend.Modelos.Usuario;","","namespace Backend.Servicios","{","    public interface IServicioAutenticacion","    {","        Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto);","        Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto);","        Task<List<UsuarioDto>> ObtenerUsuariosAsync();","        Task<UsuarioDto?> ObtenerUsuarioPorIdAsync(int id);","    }","","    public class ServicioAutenticacion : IServicioAutenticacion","    {","        private readonly ApiDbContext _db;","        private readonly IDataProtector _protector;","","        public ServicioAutenticacion(ApiDbContext db, IDataProtectionProvider provider)","        {","            _db = db;","            _protector = provider.CreateProtector(\"UserData\");","        }","","        private string SafeUnprotect(string encrypted)","        {","            if (string.IsNullOrEmpty(encrypted)) return encrypted;","            try { return _protector.Unprotect(encrypted); } ","            catch { return encrypted; }","        }","","        public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto)","        {","            if (string.IsNullOrWhiteSpace(dto.correo)) throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.contrasena)) throw new ArgumentException(\"Contraseña es obligatoria\");","            ","            if (await _db.usuarios.AnyAsync(u => SafeUnprotect(u.correo) == dto.correo))","                throw new InvalidOperationException(\"El correo ya está registrado\");","","            var passwordHash = Argon2.Hash(dto.contrasena);","","            var user = new usuarios","            {","                correo = _protector.Protect(dto.correo),","                hash_contrasena = passwordHash,","                nombre = _protector.Protect(dto.nombre),","                apellidos = _protector.Protect(dto.apellidos ?? \"\"),","                telefono = _protector.Protect(dto.telefono ?? \"\"),","                curp = _protector.Protect(dto.curp ?? \"\"),","                direccion = _protector.Protect(dto.direccion ?? \"\"),","                tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","                esta_activo = true,","                creado_en = DateTime.UtcNow","            };","","            _db.usuarios.Add(user);","            await _db.SaveChangesAsync();","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = dto.correo,","                Nombre = dto.nombre,","                Apellidos = dto.apellidos ?? \"\",","                Telefono = dto.telefono ?? \"\",","                Curp = dto.curp ?? \"\",","                Direccion = dto.direccion ?? \"\",","                TipoUsuario = user.tipo_usuario,","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","","        public async Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto)","        {","            var usuarios = await _db.usuarios.ToListAsync();","            var user = usuarios.FirstOrDefault(u => SafeUnprotect(u.correo).Equals(dto.Correo, StringComparison.OrdinalIgnoreCase));","","            if (user == null) throw new InvalidOperationException(\"Usuario no encontrado\");","            if (!Argon2.Verify(user.hash_contrasena, dto.Contrasena)) throw new ArgumentException(\"Contraseña incorrecta\");","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = SafeUnprotect(user.correo),","                Nombre = SafeUnprotect(user.nombre),","                Apellidos = SafeUnprotect(user.apellidos),","                Telefono = SafeUnprotect(user.telefono),","                Curp = SafeUnprotect(user.curp),","                Direccion = SafeUnprotect(user.direccion),","                TipoUsuario = user.tipo_usuario ?? \"JOVEN\",","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","","        public async Task<List<UsuarioDto>> ObtenerUsuariosAsync()","        {","            var usuarios = await _db.usuarios.ToListAsync();","            return usuarios.Select(u => new UsuarioDto","            {","                Id = u.id,","                Correo = SafeUnprotect(u.correo),","                Nombre = SafeUnprotect(u.nombre),","                Apellidos = SafeUnprotect(u.apellidos),","                Telefono = SafeUnprotect(u.telefono),","                Curp = SafeUnprotect(u.curp),","                Direccion = SafeUnprotect(u.direccion),","                TipoUsuario = u.tipo_usuario ?? \"JOVEN\",","                EstaActivo = u.esta_activo,","                CreadoEn = u.creado_en","            }).ToList();","        }","","        public async Task<UsuarioDto?> ObtenerUsuarioPorIdAsync(int id)","        {","            var user = await _db.usuarios.FindAsync(id);","            if (user == null) return null;","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = SafeUnprotect(user.correo),","                Nombre = SafeUnprotect(user.nombre),","                Apellidos = SafeUnprotect(user.apellidos),","                Telefono = SafeUnprotect(user.telefono),","                Curp = SafeUnprotect(user.curp),","                Direccion = SafeUnprotect(user.direccion),","                TipoUsuario = user.tipo_usuario ?? \"JOVEN\",","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","    }","}",""],"id":235},{"start":{"row":0,"column":0},"end":{"row":120,"column":0},"action":"insert","lines":["using Isopoh.Cryptography.Argon2;","using Microsoft.EntityFrameworkCore;","using Microsoft.AspNetCore.DataProtection;","using Backend.Modelos.Usuario;","","namespace Backend.Servicios","{","    public interface IServicioAutenticacion","    {","        Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto, IDataProtector protector);","        Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto, IDataProtector protector);","    }","","    public class ServicioAutenticacion : IServicioAutenticacion","    {","        private readonly ApiDbContext _db;","","        public ServicioAutenticacion(ApiDbContext db)","        {","            _db = db;","        }","","        // Método seguro para desencriptar","        public static string SafeUnprotect(IDataProtector protector, string encrypted)","        {","            if (string.IsNullOrEmpty(encrypted)) return encrypted;","            try","            {","                return protector.Unprotect(encrypted);","            }","            catch","            {","                return encrypted;","            }","        }","","        public async Task<UsuarioDto> RegistrarAsync(UsuarioCrearDto dto, IDataProtector protector)","        {","            if (string.IsNullOrWhiteSpace(dto.correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","","            // Traer todos los usuarios a memoria para validar correo único","            var usuarios = await _db.usuarios.ToListAsync();","","            if (usuarios.Any(u => SafeUnprotect(protector, u.correo) == dto.correo))","                throw new InvalidOperationException(\"El correo ya está registrado\");","","            // Hash de contraseña","            string passwordHash = Argon2.Hash(dto.contrasena);","","            var user = new usuarios","            {","                correo = protector.Protect(dto.correo),","                hash_contrasena = passwordHash,","                nombre = protector.Protect(dto.nombre),","                apellidos = protector.Protect(dto.apellidos ?? \"\"),","                telefono = protector.Protect(dto.telefono ?? \"\"),","                curp = protector.Protect(dto.curp ?? \"\"),","                direccion = protector.Protect(dto.direccion ?? \"\"),","                tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","                esta_activo = true,","                creado_en = DateTime.UtcNow","            };","","            _db.usuarios.Add(user);","            await _db.SaveChangesAsync();","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = dto.correo,","                Nombre = dto.nombre,","                Apellidos = dto.apellidos ?? \"\",","                Telefono = dto.telefono ?? \"\",","                Curp = dto.curp ?? \"\",","                Direccion = dto.direccion ?? \"\",","                TipoUsuario = user.tipo_usuario,","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","","        public async Task<UsuarioDto> LoginAsync(UsuarioLoginDto dto, IDataProtector protector)","        {","            if (string.IsNullOrWhiteSpace(dto.Correo))","                throw new ArgumentException(\"Correo es obligatorio\");","            if (string.IsNullOrWhiteSpace(dto.Contrasena))","                throw new ArgumentException(\"Contraseña es obligatoria\");","","            // Traer usuarios a memoria para desencriptar","            var usuarios = await _db.usuarios.ToListAsync();","","            var user = usuarios.FirstOrDefault(u =>","                SafeUnprotect(protector, u.correo).Equals(dto.Correo, StringComparison.OrdinalIgnoreCase)","            );","","            if (user == null)","                throw new InvalidOperationException(\"Usuario no encontrado\");","","            if (!Argon2.Verify(user.hash_contrasena, dto.Contrasena))","                throw new ArgumentException(\"Contraseña incorrecta\");","","            return new UsuarioDto","            {","                Id = user.id,","                Correo = dto.Correo,","                Nombre = SafeUnprotect(protector, user.nombre),","                Apellidos = SafeUnprotect(protector, user.apellidos),","                Telefono = SafeUnprotect(protector, user.telefono),","                Curp = SafeUnprotect(protector, user.curp),","                Direccion = SafeUnprotect(protector, user.direccion),","                TipoUsuario = user.tipo_usuario,","                EstaActivo = user.esta_activo,","                CreadoEn = user.creado_en","            };","        }","    }","}",""]}],[{"start":{"row":22,"column":42},"end":{"row":22,"column":43},"action":"insert","lines":[" "],"id":236}],[{"start":{"row":47,"column":84},"end":{"row":48,"column":0},"action":"insert","lines":["",""],"id":237},{"start":{"row":48,"column":0},"end":{"row":48,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":48,"column":12},"end":{"row":48,"column":16},"action":"remove","lines":["    "],"id":238}],[{"start":{"row":48,"column":12},"end":{"row":49,"column":84},"action":"insert","lines":["if (usuarios.Any(u => SafeUnprotect(protector, u.correo) == dto.correo))","                throw new InvalidOperationException(\"El correo ya está registrado\");"],"id":239}],[{"start":{"row":48,"column":61},"end":{"row":48,"column":67},"action":"remove","lines":["correo"],"id":240},{"start":{"row":48,"column":61},"end":{"row":48,"column":62},"action":"insert","lines":["t"]},{"start":{"row":48,"column":62},"end":{"row":48,"column":63},"action":"insert","lines":["e"]}],[{"start":{"row":48,"column":61},"end":{"row":48,"column":63},"action":"remove","lines":["te"],"id":241},{"start":{"row":48,"column":61},"end":{"row":48,"column":69},"action":"insert","lines":["telefono"]}],[{"start":{"row":48,"column":78},"end":{"row":48,"column":84},"action":"remove","lines":["correo"],"id":242},{"start":{"row":48,"column":78},"end":{"row":48,"column":79},"action":"insert","lines":["t"]},{"start":{"row":48,"column":79},"end":{"row":48,"column":80},"action":"insert","lines":["e"]}],[{"start":{"row":48,"column":78},"end":{"row":48,"column":80},"action":"remove","lines":["te"],"id":243},{"start":{"row":48,"column":78},"end":{"row":48,"column":86},"action":"insert","lines":["telefono"]}],[{"start":{"row":49,"column":56},"end":{"row":49,"column":62},"action":"remove","lines":["correo"],"id":244},{"start":{"row":49,"column":56},"end":{"row":49,"column":57},"action":"insert","lines":["t"]},{"start":{"row":49,"column":57},"end":{"row":49,"column":58},"action":"insert","lines":["e"]},{"start":{"row":49,"column":58},"end":{"row":49,"column":59},"action":"insert","lines":["l"]}],[{"start":{"row":49,"column":56},"end":{"row":49,"column":59},"action":"remove","lines":["tel"],"id":245},{"start":{"row":49,"column":56},"end":{"row":49,"column":64},"action":"insert","lines":["telefono"]}],[{"start":{"row":49,"column":86},"end":{"row":50,"column":0},"action":"insert","lines":["",""],"id":246},{"start":{"row":50,"column":0},"end":{"row":50,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":50,"column":12},"end":{"row":50,"column":16},"action":"remove","lines":["    "],"id":247}],[{"start":{"row":50,"column":12},"end":{"row":51,"column":86},"action":"insert","lines":["if (usuarios.Any(u => SafeUnprotect(protector, u.telefono) == dto.telefono))","                throw new InvalidOperationException(\"El telefono ya está registrado\");"],"id":248}],[{"start":{"row":46,"column":84},"end":{"row":46,"column":85},"action":"insert","lines":[" "],"id":249},{"start":{"row":46,"column":85},"end":{"row":46,"column":86},"action":"insert","lines":["/"]},{"start":{"row":46,"column":86},"end":{"row":46,"column":87},"action":"insert","lines":["/"]}],[{"start":{"row":46,"column":87},"end":{"row":46,"column":88},"action":"insert","lines":[" "],"id":250},{"start":{"row":46,"column":88},"end":{"row":46,"column":89},"action":"insert","lines":["C"]},{"start":{"row":46,"column":89},"end":{"row":46,"column":90},"action":"insert","lines":["o"]},{"start":{"row":46,"column":90},"end":{"row":46,"column":91},"action":"insert","lines":["m"]},{"start":{"row":46,"column":91},"end":{"row":46,"column":92},"action":"insert","lines":["p"]},{"start":{"row":46,"column":92},"end":{"row":46,"column":93},"action":"insert","lines":["r"]},{"start":{"row":46,"column":93},"end":{"row":46,"column":94},"action":"insert","lines":["o"]},{"start":{"row":46,"column":94},"end":{"row":46,"column":95},"action":"insert","lines":["b"]},{"start":{"row":46,"column":95},"end":{"row":46,"column":96},"action":"insert","lines":["a"]},{"start":{"row":46,"column":96},"end":{"row":46,"column":97},"action":"insert","lines":["c"]},{"start":{"row":46,"column":97},"end":{"row":46,"column":98},"action":"insert","lines":["i"]}],[{"start":{"row":46,"column":98},"end":{"row":46,"column":99},"action":"insert","lines":["o"],"id":251},{"start":{"row":46,"column":99},"end":{"row":46,"column":100},"action":"insert","lines":["n"]}],[{"start":{"row":46,"column":100},"end":{"row":46,"column":101},"action":"insert","lines":[" "],"id":252},{"start":{"row":46,"column":101},"end":{"row":46,"column":102},"action":"insert","lines":["d"]},{"start":{"row":46,"column":102},"end":{"row":46,"column":103},"action":"insert","lines":["e"]}],[{"start":{"row":46,"column":103},"end":{"row":46,"column":104},"action":"insert","lines":[" "],"id":253},{"start":{"row":46,"column":104},"end":{"row":46,"column":105},"action":"insert","lines":["c"]},{"start":{"row":46,"column":105},"end":{"row":46,"column":106},"action":"insert","lines":["o"]},{"start":{"row":46,"column":106},"end":{"row":46,"column":107},"action":"insert","lines":["r"]},{"start":{"row":46,"column":107},"end":{"row":46,"column":108},"action":"insert","lines":["r"]},{"start":{"row":46,"column":108},"end":{"row":46,"column":109},"action":"insert","lines":["e"]},{"start":{"row":46,"column":109},"end":{"row":46,"column":110},"action":"insert","lines":["o"]}],[{"start":{"row":46,"column":110},"end":{"row":46,"column":111},"action":"insert","lines":[" "],"id":254},{"start":{"row":46,"column":111},"end":{"row":46,"column":112},"action":"insert","lines":["r"]},{"start":{"row":46,"column":112},"end":{"row":46,"column":113},"action":"insert","lines":["e"]},{"start":{"row":46,"column":113},"end":{"row":46,"column":114},"action":"insert","lines":["p"]},{"start":{"row":46,"column":114},"end":{"row":46,"column":115},"action":"insert","lines":["e"]},{"start":{"row":46,"column":115},"end":{"row":46,"column":116},"action":"insert","lines":["t"]},{"start":{"row":46,"column":116},"end":{"row":46,"column":117},"action":"insert","lines":["i"]},{"start":{"row":46,"column":117},"end":{"row":46,"column":118},"action":"insert","lines":["d"]},{"start":{"row":46,"column":118},"end":{"row":46,"column":119},"action":"insert","lines":["o"]}],[{"start":{"row":48,"column":88},"end":{"row":48,"column":89},"action":"insert","lines":[" "],"id":255}],[{"start":{"row":48,"column":89},"end":{"row":48,"column":123},"action":"insert","lines":["// Comprobacion de correo repetido"],"id":256}],[{"start":{"row":50,"column":88},"end":{"row":50,"column":89},"action":"insert","lines":[" "],"id":257}],[{"start":{"row":50,"column":89},"end":{"row":50,"column":123},"action":"insert","lines":["// Comprobacion de correo repetido"],"id":258}],[{"start":{"row":48,"column":108},"end":{"row":48,"column":114},"action":"remove","lines":["correo"],"id":259},{"start":{"row":48,"column":108},"end":{"row":48,"column":109},"action":"insert","lines":["t"]},{"start":{"row":48,"column":109},"end":{"row":48,"column":110},"action":"insert","lines":["e"]},{"start":{"row":48,"column":110},"end":{"row":48,"column":111},"action":"insert","lines":["l"]},{"start":{"row":48,"column":111},"end":{"row":48,"column":112},"action":"insert","lines":["e"]},{"start":{"row":48,"column":112},"end":{"row":48,"column":113},"action":"insert","lines":["f"]},{"start":{"row":48,"column":113},"end":{"row":48,"column":114},"action":"insert","lines":["o"]},{"start":{"row":48,"column":114},"end":{"row":48,"column":115},"action":"insert","lines":["n"]},{"start":{"row":48,"column":115},"end":{"row":48,"column":116},"action":"insert","lines":["o"]}],[{"start":{"row":50,"column":61},"end":{"row":50,"column":69},"action":"remove","lines":["telefono"],"id":260},{"start":{"row":50,"column":61},"end":{"row":50,"column":62},"action":"insert","lines":["c"]},{"start":{"row":50,"column":62},"end":{"row":50,"column":63},"action":"insert","lines":["u"]},{"start":{"row":50,"column":63},"end":{"row":50,"column":64},"action":"insert","lines":["r"]}],[{"start":{"row":50,"column":61},"end":{"row":50,"column":64},"action":"remove","lines":["cur"],"id":261},{"start":{"row":50,"column":61},"end":{"row":50,"column":65},"action":"insert","lines":["curp"]}],[{"start":{"row":50,"column":74},"end":{"row":50,"column":82},"action":"remove","lines":["telefono"],"id":262},{"start":{"row":50,"column":74},"end":{"row":50,"column":75},"action":"insert","lines":["c"]},{"start":{"row":50,"column":75},"end":{"row":50,"column":76},"action":"insert","lines":["u"]},{"start":{"row":50,"column":76},"end":{"row":50,"column":77},"action":"insert","lines":["r"]}],[{"start":{"row":50,"column":74},"end":{"row":50,"column":77},"action":"remove","lines":["cur"],"id":263},{"start":{"row":50,"column":74},"end":{"row":50,"column":78},"action":"insert","lines":["curp"]}],[{"start":{"row":51,"column":56},"end":{"row":51,"column":64},"action":"remove","lines":["telefono"],"id":264},{"start":{"row":51,"column":56},"end":{"row":51,"column":57},"action":"insert","lines":["c"]},{"start":{"row":51,"column":57},"end":{"row":51,"column":58},"action":"insert","lines":["u"]},{"start":{"row":51,"column":58},"end":{"row":51,"column":59},"action":"insert","lines":["r"]}],[{"start":{"row":51,"column":56},"end":{"row":51,"column":59},"action":"remove","lines":["cur"],"id":265},{"start":{"row":51,"column":56},"end":{"row":51,"column":60},"action":"insert","lines":["curp"]}],[{"start":{"row":50,"column":100},"end":{"row":50,"column":106},"action":"remove","lines":["correo"],"id":266},{"start":{"row":50,"column":100},"end":{"row":50,"column":101},"action":"insert","lines":["c"]},{"start":{"row":50,"column":101},"end":{"row":50,"column":102},"action":"insert","lines":["u"]},{"start":{"row":50,"column":102},"end":{"row":50,"column":103},"action":"insert","lines":["r"]},{"start":{"row":50,"column":103},"end":{"row":50,"column":104},"action":"insert","lines":["p"]}],[{"start":{"row":45,"column":0},"end":{"row":45,"column":4},"action":"insert","lines":["    "],"id":267}],[{"start":{"row":45,"column":4},"end":{"row":45,"column":8},"action":"insert","lines":["    "],"id":268}],[{"start":{"row":45,"column":8},"end":{"row":45,"column":12},"action":"insert","lines":["    "],"id":269}],[{"start":{"row":45,"column":12},"end":{"row":45,"column":13},"action":"insert","lines":["E"],"id":270}],[{"start":{"row":45,"column":12},"end":{"row":45,"column":13},"action":"remove","lines":["E"],"id":271}],[{"start":{"row":45,"column":12},"end":{"row":45,"column":13},"action":"insert","lines":["/"],"id":272},{"start":{"row":45,"column":13},"end":{"row":45,"column":14},"action":"insert","lines":["/"]},{"start":{"row":45,"column":14},"end":{"row":45,"column":15},"action":"insert","lines":["E"]},{"start":{"row":45,"column":15},"end":{"row":45,"column":16},"action":"insert","lines":["s"]}],[{"start":{"row":45,"column":15},"end":{"row":45,"column":16},"action":"remove","lines":["s"],"id":273}],[{"start":{"row":45,"column":15},"end":{"row":45,"column":16},"action":"insert","lines":["x"],"id":274},{"start":{"row":45,"column":16},"end":{"row":45,"column":17},"action":"insert","lines":["c"]},{"start":{"row":45,"column":17},"end":{"row":45,"column":18},"action":"insert","lines":["e"]},{"start":{"row":45,"column":18},"end":{"row":45,"column":19},"action":"insert","lines":["p"]},{"start":{"row":45,"column":19},"end":{"row":45,"column":20},"action":"insert","lines":["t"]}],[{"start":{"row":45,"column":19},"end":{"row":45,"column":20},"action":"remove","lines":["t"],"id":275}],[{"start":{"row":45,"column":19},"end":{"row":45,"column":20},"action":"insert","lines":["c"],"id":276},{"start":{"row":45,"column":20},"end":{"row":45,"column":21},"action":"insert","lines":["i"]},{"start":{"row":45,"column":21},"end":{"row":45,"column":22},"action":"insert","lines":["o"]},{"start":{"row":45,"column":22},"end":{"row":45,"column":23},"action":"insert","lines":["n"]},{"start":{"row":45,"column":23},"end":{"row":45,"column":24},"action":"insert","lines":["e"]},{"start":{"row":45,"column":24},"end":{"row":45,"column":25},"action":"insert","lines":["s"]}],[{"start":{"row":45,"column":14},"end":{"row":45,"column":25},"action":"remove","lines":["Excepciones"],"id":277}],[{"start":{"row":45,"column":14},"end":{"row":45,"column":15},"action":"insert","lines":["e"],"id":278},{"start":{"row":45,"column":15},"end":{"row":45,"column":16},"action":"insert","lines":["s"]},{"start":{"row":45,"column":16},"end":{"row":45,"column":17},"action":"insert","lines":["c"]},{"start":{"row":45,"column":17},"end":{"row":45,"column":18},"action":"insert","lines":["e"]}],[{"start":{"row":45,"column":18},"end":{"row":45,"column":19},"action":"insert","lines":["p"],"id":279},{"start":{"row":45,"column":19},"end":{"row":45,"column":20},"action":"insert","lines":["c"]},{"start":{"row":45,"column":20},"end":{"row":45,"column":21},"action":"insert","lines":["i"]}],[{"start":{"row":45,"column":14},"end":{"row":45,"column":21},"action":"remove","lines":["escepci"],"id":280}],[{"start":{"row":45,"column":14},"end":{"row":45,"column":15},"action":"insert","lines":["c"],"id":281},{"start":{"row":45,"column":15},"end":{"row":45,"column":16},"action":"insert","lines":["o"]},{"start":{"row":45,"column":16},"end":{"row":45,"column":17},"action":"insert","lines":["m"]}],[{"start":{"row":45,"column":16},"end":{"row":45,"column":17},"action":"remove","lines":["m"],"id":282},{"start":{"row":45,"column":15},"end":{"row":45,"column":16},"action":"remove","lines":["o"]},{"start":{"row":45,"column":14},"end":{"row":45,"column":15},"action":"remove","lines":["c"]}],[{"start":{"row":45,"column":14},"end":{"row":45,"column":15},"action":"insert","lines":["C"],"id":283},{"start":{"row":45,"column":15},"end":{"row":45,"column":16},"action":"insert","lines":["o"]},{"start":{"row":45,"column":16},"end":{"row":45,"column":17},"action":"insert","lines":["m"]},{"start":{"row":45,"column":17},"end":{"row":45,"column":18},"action":"insert","lines":["p"]},{"start":{"row":45,"column":18},"end":{"row":45,"column":19},"action":"insert","lines":["r"]},{"start":{"row":45,"column":19},"end":{"row":45,"column":20},"action":"insert","lines":["o"]},{"start":{"row":45,"column":20},"end":{"row":45,"column":21},"action":"insert","lines":["n"]},{"start":{"row":45,"column":21},"end":{"row":45,"column":22},"action":"insert","lines":["a"]},{"start":{"row":45,"column":22},"end":{"row":45,"column":23},"action":"insert","lines":["c"]},{"start":{"row":45,"column":23},"end":{"row":45,"column":24},"action":"insert","lines":["i"]},{"start":{"row":45,"column":24},"end":{"row":45,"column":25},"action":"insert","lines":["o"]},{"start":{"row":45,"column":25},"end":{"row":45,"column":26},"action":"insert","lines":["n"]},{"start":{"row":45,"column":26},"end":{"row":45,"column":27},"action":"insert","lines":["e"]}],[{"start":{"row":45,"column":27},"end":{"row":45,"column":28},"action":"insert","lines":["s"],"id":284}],[{"start":{"row":45,"column":12},"end":{"row":46,"column":0},"action":"insert","lines":["",""],"id":285},{"start":{"row":46,"column":0},"end":{"row":46,"column":12},"action":"insert","lines":["            "]}],[{"start":{"row":22,"column":25},"end":{"row":22,"column":43},"action":"remove","lines":["para desencriptar "],"id":286},{"start":{"row":22,"column":24},"end":{"row":22,"column":25},"action":"remove","lines":[" "]},{"start":{"row":22,"column":23},"end":{"row":22,"column":24},"action":"remove","lines":["o"]},{"start":{"row":22,"column":22},"end":{"row":22,"column":23},"action":"remove","lines":["r"]},{"start":{"row":22,"column":21},"end":{"row":22,"column":22},"action":"remove","lines":["u"]},{"start":{"row":22,"column":20},"end":{"row":22,"column":21},"action":"remove","lines":["g"]},{"start":{"row":22,"column":19},"end":{"row":22,"column":20},"action":"remove","lines":["e"]},{"start":{"row":22,"column":18},"end":{"row":22,"column":19},"action":"remove","lines":["s"]},{"start":{"row":22,"column":17},"end":{"row":22,"column":18},"action":"remove","lines":[" "]},{"start":{"row":22,"column":16},"end":{"row":22,"column":17},"action":"remove","lines":["o"]},{"start":{"row":22,"column":15},"end":{"row":22,"column":16},"action":"remove","lines":["d"]},{"start":{"row":22,"column":14},"end":{"row":22,"column":15},"action":"remove","lines":["o"]},{"start":{"row":22,"column":13},"end":{"row":22,"column":14},"action":"remove","lines":["t"]},{"start":{"row":22,"column":12},"end":{"row":22,"column":13},"action":"remove","lines":["é"]}],[{"start":{"row":22,"column":11},"end":{"row":22,"column":12},"action":"remove","lines":["M"],"id":287}],[{"start":{"row":22,"column":11},"end":{"row":22,"column":12},"action":"insert","lines":["E"],"id":288},{"start":{"row":22,"column":12},"end":{"row":22,"column":13},"action":"insert","lines":["S"]},{"start":{"row":22,"column":13},"end":{"row":22,"column":14},"action":"insert","lines":["T"]},{"start":{"row":22,"column":14},"end":{"row":22,"column":15},"action":"insert","lines":["E"]}],[{"start":{"row":22,"column":15},"end":{"row":22,"column":16},"action":"insert","lines":[" "],"id":289},{"start":{"row":22,"column":16},"end":{"row":22,"column":17},"action":"insert","lines":["E"]},{"start":{"row":22,"column":17},"end":{"row":22,"column":18},"action":"insert","lines":["S"]}],[{"start":{"row":22,"column":18},"end":{"row":22,"column":19},"action":"insert","lines":[" "],"id":290},{"start":{"row":22,"column":19},"end":{"row":22,"column":20},"action":"insert","lines":["E"]},{"start":{"row":22,"column":20},"end":{"row":22,"column":21},"action":"insert","lines":["L"]}],[{"start":{"row":22,"column":21},"end":{"row":22,"column":22},"action":"insert","lines":[" "],"id":291},{"start":{"row":22,"column":22},"end":{"row":22,"column":23},"action":"insert","lines":["M"]},{"start":{"row":22,"column":23},"end":{"row":22,"column":24},"action":"insert","lines":["E"]},{"start":{"row":22,"column":24},"end":{"row":22,"column":25},"action":"insert","lines":["T"]},{"start":{"row":22,"column":25},"end":{"row":22,"column":26},"action":"insert","lines":["O"]},{"start":{"row":22,"column":26},"end":{"row":22,"column":27},"action":"insert","lines":["D"]},{"start":{"row":22,"column":27},"end":{"row":22,"column":28},"action":"insert","lines":["O"]}],[{"start":{"row":22,"column":28},"end":{"row":22,"column":29},"action":"insert","lines":[" "],"id":292},{"start":{"row":22,"column":29},"end":{"row":22,"column":30},"action":"insert","lines":["U"]},{"start":{"row":22,"column":30},"end":{"row":22,"column":31},"action":"insert","lines":["S"]},{"start":{"row":22,"column":31},"end":{"row":22,"column":32},"action":"insert","lines":["A"]},{"start":{"row":22,"column":32},"end":{"row":22,"column":33},"action":"insert","lines":["D"]},{"start":{"row":22,"column":33},"end":{"row":22,"column":34},"action":"insert","lines":["O"]}],[{"start":{"row":22,"column":34},"end":{"row":22,"column":35},"action":"insert","lines":[" "],"id":293},{"start":{"row":22,"column":35},"end":{"row":22,"column":36},"action":"insert","lines":["P"]},{"start":{"row":22,"column":36},"end":{"row":22,"column":37},"action":"insert","lines":["A"]},{"start":{"row":22,"column":37},"end":{"row":22,"column":38},"action":"insert","lines":["R"]},{"start":{"row":22,"column":38},"end":{"row":22,"column":39},"action":"insert","lines":["A"]}],[{"start":{"row":22,"column":39},"end":{"row":22,"column":40},"action":"insert","lines":[" "],"id":294},{"start":{"row":22,"column":40},"end":{"row":22,"column":41},"action":"insert","lines":["D"]},{"start":{"row":22,"column":41},"end":{"row":22,"column":42},"action":"insert","lines":["E"]},{"start":{"row":22,"column":42},"end":{"row":22,"column":43},"action":"insert","lines":["S"]},{"start":{"row":22,"column":43},"end":{"row":22,"column":44},"action":"insert","lines":["E"]}],[{"start":{"row":22,"column":44},"end":{"row":22,"column":45},"action":"insert","lines":["N"],"id":295},{"start":{"row":22,"column":45},"end":{"row":22,"column":46},"action":"insert","lines":["C"]},{"start":{"row":22,"column":46},"end":{"row":22,"column":47},"action":"insert","lines":["R"]},{"start":{"row":22,"column":47},"end":{"row":22,"column":48},"action":"insert","lines":["I"]},{"start":{"row":22,"column":48},"end":{"row":22,"column":49},"action":"insert","lines":["P"]},{"start":{"row":22,"column":49},"end":{"row":22,"column":50},"action":"insert","lines":["T"]},{"start":{"row":22,"column":50},"end":{"row":22,"column":51},"action":"insert","lines":["A"]},{"start":{"row":22,"column":51},"end":{"row":22,"column":52},"action":"insert","lines":["R"]}],[{"start":{"row":22,"column":52},"end":{"row":22,"column":53},"action":"insert","lines":[","],"id":296}],[{"start":{"row":22,"column":53},"end":{"row":22,"column":54},"action":"insert","lines":[" "],"id":297}],[{"start":{"row":22,"column":53},"end":{"row":22,"column":54},"action":"remove","lines":[" "],"id":298},{"start":{"row":22,"column":52},"end":{"row":22,"column":53},"action":"remove","lines":[","]}],[{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "],"id":299}],[{"start":{"row":88,"column":4},"end":{"row":88,"column":8},"action":"insert","lines":["    "],"id":300}],[{"start":{"row":88,"column":8},"end":{"row":89,"column":0},"action":"insert","lines":["",""],"id":301},{"start":{"row":89,"column":0},"end":{"row":89,"column":8},"action":"insert","lines":["        "]},{"start":{"row":89,"column":8},"end":{"row":89,"column":9},"action":"insert","lines":["/"]},{"start":{"row":89,"column":9},"end":{"row":89,"column":10},"action":"insert","lines":["/"]}],[{"start":{"row":89,"column":10},"end":{"row":89,"column":11},"action":"insert","lines":["M"],"id":302},{"start":{"row":89,"column":11},"end":{"row":89,"column":12},"action":"insert","lines":["e"]},{"start":{"row":89,"column":12},"end":{"row":89,"column":13},"action":"insert","lines":["t"]},{"start":{"row":89,"column":13},"end":{"row":89,"column":14},"action":"insert","lines":["o"]},{"start":{"row":89,"column":14},"end":{"row":89,"column":15},"action":"insert","lines":["d"]},{"start":{"row":89,"column":15},"end":{"row":89,"column":16},"action":"insert","lines":["o"]}],[{"start":{"row":89,"column":16},"end":{"row":89,"column":17},"action":"insert","lines":[" "],"id":303},{"start":{"row":89,"column":17},"end":{"row":89,"column":18},"action":"insert","lines":["p"]},{"start":{"row":89,"column":18},"end":{"row":89,"column":19},"action":"insert","lines":["a"]},{"start":{"row":89,"column":19},"end":{"row":89,"column":20},"action":"insert","lines":["r"]},{"start":{"row":89,"column":20},"end":{"row":89,"column":21},"action":"insert","lines":["a"]}],[{"start":{"row":89,"column":21},"end":{"row":89,"column":22},"action":"insert","lines":[" "],"id":304},{"start":{"row":89,"column":22},"end":{"row":89,"column":23},"action":"insert","lines":["e"]},{"start":{"row":89,"column":23},"end":{"row":89,"column":24},"action":"insert","lines":["l"]}],[{"start":{"row":89,"column":24},"end":{"row":89,"column":25},"action":"insert","lines":[" "],"id":305},{"start":{"row":89,"column":25},"end":{"row":89,"column":26},"action":"insert","lines":["l"]},{"start":{"row":89,"column":26},"end":{"row":89,"column":27},"action":"insert","lines":["o"]},{"start":{"row":89,"column":27},"end":{"row":89,"column":28},"action":"insert","lines":["g"]},{"start":{"row":89,"column":28},"end":{"row":89,"column":29},"action":"insert","lines":["i"]},{"start":{"row":89,"column":29},"end":{"row":89,"column":30},"action":"insert","lines":["n"]}],[{"start":{"row":91,"column":9},"end":{"row":92,"column":0},"action":"insert","lines":["",""],"id":306},{"start":{"row":92,"column":0},"end":{"row":92,"column":12},"action":"insert","lines":["            "]},{"start":{"row":92,"column":12},"end":{"row":92,"column":13},"action":"insert","lines":["/"]},{"start":{"row":92,"column":13},"end":{"row":92,"column":14},"action":"insert","lines":["/"]},{"start":{"row":92,"column":14},"end":{"row":92,"column":15},"action":"insert","lines":["C"]}],[{"start":{"row":92,"column":15},"end":{"row":92,"column":16},"action":"insert","lines":["o"],"id":307},{"start":{"row":92,"column":16},"end":{"row":92,"column":17},"action":"insert","lines":["m"]},{"start":{"row":92,"column":17},"end":{"row":92,"column":18},"action":"insert","lines":["p"]},{"start":{"row":92,"column":18},"end":{"row":92,"column":19},"action":"insert","lines":["r"]},{"start":{"row":92,"column":19},"end":{"row":92,"column":20},"action":"insert","lines":["o"]},{"start":{"row":92,"column":20},"end":{"row":92,"column":21},"action":"insert","lines":["b"]},{"start":{"row":92,"column":21},"end":{"row":92,"column":22},"action":"insert","lines":["a"]},{"start":{"row":92,"column":22},"end":{"row":92,"column":23},"action":"insert","lines":["c"]},{"start":{"row":92,"column":23},"end":{"row":92,"column":24},"action":"insert","lines":["i"]},{"start":{"row":92,"column":24},"end":{"row":92,"column":25},"action":"insert","lines":["o"]},{"start":{"row":92,"column":25},"end":{"row":92,"column":26},"action":"insert","lines":["n"]},{"start":{"row":92,"column":26},"end":{"row":92,"column":27},"action":"insert","lines":["e"]},{"start":{"row":92,"column":27},"end":{"row":92,"column":28},"action":"insert","lines":["s"]}]]},"ace":{"folds":[],"scrolltop":699.6000000000006,"scrollleft":0,"selection":{"start":{"row":80,"column":46},"end":{"row":80,"column":46},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1759527269570,"hash":"56ab883c77ce48b73d58fdc4160acd7aacccd64f"}