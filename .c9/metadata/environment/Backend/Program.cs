{"filter":false,"title":"Program.cs","tooltip":"/Backend/Program.cs","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":42,"column":34},"end":{"row":42,"column":35},"action":"remove","lines":["i"],"id":473},{"start":{"row":42,"column":33},"end":{"row":42,"column":34},"action":"remove","lines":["l"]},{"start":{"row":42,"column":32},"end":{"row":42,"column":33},"action":"remove","lines":["a"]}],[{"start":{"row":42,"column":32},"end":{"row":42,"column":33},"action":"insert","lines":["v"],"id":474},{"start":{"row":42,"column":33},"end":{"row":42,"column":34},"action":"insert","lines":["a"]},{"start":{"row":42,"column":34},"end":{"row":42,"column":35},"action":"insert","lines":["l"]},{"start":{"row":42,"column":35},"end":{"row":42,"column":36},"action":"insert","lines":["i"]},{"start":{"row":42,"column":36},"end":{"row":42,"column":37},"action":"insert","lines":["o"]}],[{"start":{"row":42,"column":37},"end":{"row":42,"column":38},"action":"insert","lines":[" "],"id":475},{"start":{"row":42,"column":38},"end":{"row":42,"column":39},"action":"insert","lines":["x"]},{"start":{"row":42,"column":39},"end":{"row":42,"column":40},"action":"insert","lines":["d"]}],[{"start":{"row":163,"column":4},"end":{"row":163,"column":84},"action":"remove","lines":["var user = await db.usuarios.FirstOrDefaultAsync(u => u.correo == login.correo);"],"id":476}],[{"start":{"row":163,"column":4},"end":{"row":165,"column":2},"action":"insert","lines":["var user = usuarios.FirstOrDefault(u =>","    SafeUnprotect(protector, u.correo).Equals(login.correo, StringComparison.OrdinalIgnoreCase)",");"],"id":477}],[{"start":{"row":164,"column":0},"end":{"row":164,"column":4},"action":"remove","lines":["    "],"id":478},{"start":{"row":163,"column":43},"end":{"row":164,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":163,"column":43},"end":{"row":163,"column":44},"action":"insert","lines":[" "],"id":479}],[{"start":{"row":163,"column":135},"end":{"row":164,"column":0},"action":"remove","lines":["",""],"id":480}],[{"start":{"row":164,"column":4},"end":{"row":164,"column":5},"action":"insert","lines":["S"],"id":481}],[{"start":{"row":164,"column":4},"end":{"row":164,"column":5},"action":"remove","lines":["S"],"id":482}],[{"start":{"row":163,"column":15},"end":{"row":163,"column":16},"action":"insert","lines":["d"],"id":483},{"start":{"row":163,"column":16},"end":{"row":163,"column":17},"action":"insert","lines":["b"]},{"start":{"row":163,"column":17},"end":{"row":163,"column":18},"action":"insert","lines":["."]}],[{"start":{"row":163,"column":4},"end":{"row":164,"column":4},"action":"remove","lines":["var user = db.usuarios.FirstOrDefault(u => SafeUnprotect(protector, u.correo).Equals(login.correo, StringComparison.OrdinalIgnoreCase));","    "],"id":484}],[{"start":{"row":163,"column":4},"end":{"row":167,"column":2},"action":"insert","lines":["var usuarios = await db.usuarios.ToListAsync(); // Trae todo a memoria","","var user = usuarios.FirstOrDefault(u =>","    SafeUnprotect(protector, u.correo).Equals(login.correo, StringComparison.OrdinalIgnoreCase)",");"],"id":485}],[{"start":{"row":165,"column":0},"end":{"row":165,"column":4},"action":"insert","lines":["    "],"id":486},{"start":{"row":166,"column":0},"end":{"row":166,"column":4},"action":"insert","lines":["    "]},{"start":{"row":167,"column":0},"end":{"row":167,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":167,"column":6},"end":{"row":168,"column":0},"action":"insert","lines":["",""],"id":487},{"start":{"row":168,"column":0},"end":{"row":168,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":126,"column":17},"end":{"row":126,"column":18},"action":"insert","lines":["p"],"id":488},{"start":{"row":126,"column":18},"end":{"row":126,"column":19},"action":"insert","lines":["r"]},{"start":{"row":126,"column":19},"end":{"row":126,"column":20},"action":"insert","lines":["o"]}],[{"start":{"row":126,"column":17},"end":{"row":126,"column":20},"action":"remove","lines":["pro"],"id":489},{"start":{"row":126,"column":17},"end":{"row":126,"column":26},"action":"insert","lines":["protector"]}],[{"start":{"row":126,"column":26},"end":{"row":126,"column":27},"action":"insert","lines":["("],"id":490}],[{"start":{"row":126,"column":26},"end":{"row":126,"column":27},"action":"remove","lines":["("],"id":491}],[{"start":{"row":126,"column":26},"end":{"row":126,"column":27},"action":"insert","lines":["."],"id":492},{"start":{"row":126,"column":27},"end":{"row":126,"column":28},"action":"insert","lines":["P"]}],[{"start":{"row":126,"column":27},"end":{"row":126,"column":28},"action":"remove","lines":["P"],"id":493},{"start":{"row":126,"column":27},"end":{"row":126,"column":34},"action":"insert","lines":["Protect"]}],[{"start":{"row":126,"column":34},"end":{"row":126,"column":35},"action":"insert","lines":["("],"id":494},{"start":{"row":126,"column":35},"end":{"row":126,"column":36},"action":"insert","lines":["p"]},{"start":{"row":126,"column":36},"end":{"row":126,"column":37},"action":"insert","lines":["r"]}],[{"start":{"row":126,"column":35},"end":{"row":126,"column":37},"action":"remove","lines":["pr"],"id":495},{"start":{"row":126,"column":35},"end":{"row":126,"column":44},"action":"insert","lines":["protector"]}],[{"start":{"row":126,"column":44},"end":{"row":126,"column":45},"action":"insert","lines":[","],"id":496}],[{"start":{"row":126,"column":45},"end":{"row":126,"column":46},"action":"insert","lines":[" "],"id":497}],[{"start":{"row":126,"column":56},"end":{"row":126,"column":57},"action":"insert","lines":["="],"id":498}],[{"start":{"row":126,"column":56},"end":{"row":126,"column":57},"action":"remove","lines":["="],"id":499}],[{"start":{"row":126,"column":56},"end":{"row":126,"column":57},"action":"insert","lines":[")"],"id":500}],[{"start":{"row":126,"column":36},"end":{"row":126,"column":46},"action":"remove","lines":["rotector, "],"id":501},{"start":{"row":126,"column":35},"end":{"row":126,"column":36},"action":"remove","lines":["p"]}],[{"start":{"row":144,"column":17},"end":{"row":144,"column":21},"action":"remove","lines":["user"],"id":502},{"start":{"row":144,"column":17},"end":{"row":144,"column":18},"action":"insert","lines":["d"]},{"start":{"row":144,"column":18},"end":{"row":144,"column":19},"action":"insert","lines":["t"]},{"start":{"row":144,"column":19},"end":{"row":144,"column":20},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":74},"end":{"row":163,"column":75},"action":"insert","lines":[" "],"id":503}],[{"start":{"row":163,"column":74},"end":{"row":163,"column":75},"action":"remove","lines":[" "],"id":504}],[{"start":{"row":163,"column":74},"end":{"row":163,"column":75},"action":"insert","lines":[","],"id":505}],[{"start":{"row":163,"column":75},"end":{"row":163,"column":76},"action":"insert","lines":[" "],"id":506},{"start":{"row":163,"column":76},"end":{"row":163,"column":77},"action":"insert","lines":["E"]},{"start":{"row":163,"column":77},"end":{"row":163,"column":78},"action":"insert","lines":["s"]},{"start":{"row":163,"column":78},"end":{"row":163,"column":79},"action":"insert","lines":["t"]},{"start":{"row":163,"column":79},"end":{"row":163,"column":80},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":80},"end":{"row":163,"column":81},"action":"insert","lines":[" "],"id":507},{"start":{"row":163,"column":81},"end":{"row":163,"column":82},"action":"insert","lines":["l"]},{"start":{"row":163,"column":82},"end":{"row":163,"column":83},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":83},"end":{"row":163,"column":84},"action":"insert","lines":[" "],"id":508},{"start":{"row":163,"column":84},"end":{"row":163,"column":85},"action":"insert","lines":["c"]},{"start":{"row":163,"column":85},"end":{"row":163,"column":86},"action":"insert","lines":["o"]},{"start":{"row":163,"column":86},"end":{"row":163,"column":87},"action":"insert","lines":["n"]},{"start":{"row":163,"column":87},"end":{"row":163,"column":88},"action":"insert","lines":["s"]},{"start":{"row":163,"column":88},"end":{"row":163,"column":89},"action":"insert","lines":["i"]},{"start":{"row":163,"column":89},"end":{"row":163,"column":90},"action":"insert","lines":["d"]},{"start":{"row":163,"column":90},"end":{"row":163,"column":91},"action":"insert","lines":["e"]},{"start":{"row":163,"column":91},"end":{"row":163,"column":92},"action":"insert","lines":["r"]},{"start":{"row":163,"column":92},"end":{"row":163,"column":93},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":93},"end":{"row":163,"column":94},"action":"insert","lines":[" "],"id":509},{"start":{"row":163,"column":94},"end":{"row":163,"column":95},"action":"insert","lines":["p"]},{"start":{"row":163,"column":95},"end":{"row":163,"column":96},"action":"insert","lines":["o"]},{"start":{"row":163,"column":96},"end":{"row":163,"column":97},"action":"insert","lines":["c"]},{"start":{"row":163,"column":97},"end":{"row":163,"column":98},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":98},"end":{"row":163,"column":99},"action":"insert","lines":[" "],"id":510},{"start":{"row":163,"column":99},"end":{"row":163,"column":100},"action":"insert","lines":["o"]},{"start":{"row":163,"column":100},"end":{"row":163,"column":101},"action":"insert","lines":["p"]},{"start":{"row":163,"column":101},"end":{"row":163,"column":102},"action":"insert","lines":["t"]},{"start":{"row":163,"column":102},"end":{"row":163,"column":103},"action":"insert","lines":["i"]},{"start":{"row":163,"column":103},"end":{"row":163,"column":104},"action":"insert","lines":["m"]},{"start":{"row":163,"column":104},"end":{"row":163,"column":105},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":105},"end":{"row":163,"column":106},"action":"insert","lines":[" "],"id":511},{"start":{"row":163,"column":106},"end":{"row":163,"column":107},"action":"insert","lines":["a"]},{"start":{"row":163,"column":107},"end":{"row":163,"column":108},"action":"insert","lines":["s"]},{"start":{"row":163,"column":108},"end":{"row":163,"column":109},"action":"insert","lines":["i"]}],[{"start":{"row":163,"column":109},"end":{"row":163,"column":110},"action":"insert","lines":[" "],"id":512},{"start":{"row":163,"column":110},"end":{"row":163,"column":111},"action":"insert","lines":["q"]},{"start":{"row":163,"column":111},"end":{"row":163,"column":112},"action":"insert","lines":["e"]},{"start":{"row":163,"column":112},"end":{"row":163,"column":113},"action":"insert","lines":["u"]}],[{"start":{"row":163,"column":113},"end":{"row":163,"column":114},"action":"insert","lines":[" "],"id":513},{"start":{"row":163,"column":114},"end":{"row":163,"column":115},"action":"insert","lines":["d"]},{"start":{"row":163,"column":115},"end":{"row":163,"column":116},"action":"insert","lines":["e"]}],[{"start":{"row":163,"column":115},"end":{"row":163,"column":116},"action":"remove","lines":["e"],"id":514},{"start":{"row":163,"column":114},"end":{"row":163,"column":115},"action":"remove","lines":["d"]},{"start":{"row":163,"column":113},"end":{"row":163,"column":114},"action":"remove","lines":[" "]},{"start":{"row":163,"column":112},"end":{"row":163,"column":113},"action":"remove","lines":["u"]},{"start":{"row":163,"column":111},"end":{"row":163,"column":112},"action":"remove","lines":["e"]}],[{"start":{"row":163,"column":111},"end":{"row":163,"column":112},"action":"insert","lines":["u"],"id":515},{"start":{"row":163,"column":112},"end":{"row":163,"column":113},"action":"insert","lines":["e"]}],[{"start":{"row":163,"column":113},"end":{"row":163,"column":114},"action":"insert","lines":[" "],"id":516},{"start":{"row":163,"column":114},"end":{"row":163,"column":115},"action":"insert","lines":["d"]},{"start":{"row":163,"column":115},"end":{"row":163,"column":116},"action":"insert","lines":["e"]},{"start":{"row":163,"column":116},"end":{"row":163,"column":117},"action":"insert","lines":["b"]},{"start":{"row":163,"column":117},"end":{"row":163,"column":118},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":118},"end":{"row":163,"column":119},"action":"insert","lines":[" "],"id":517},{"start":{"row":163,"column":119},"end":{"row":163,"column":120},"action":"insert","lines":["b"]}],[{"start":{"row":163,"column":119},"end":{"row":163,"column":120},"action":"remove","lines":["b"],"id":518}],[{"start":{"row":163,"column":119},"end":{"row":163,"column":120},"action":"insert","lines":["v"],"id":519},{"start":{"row":163,"column":120},"end":{"row":163,"column":121},"action":"insert","lines":["e"]},{"start":{"row":163,"column":121},"end":{"row":163,"column":122},"action":"insert","lines":["r"]},{"start":{"row":163,"column":122},"end":{"row":163,"column":123},"action":"insert","lines":["i"]},{"start":{"row":163,"column":123},"end":{"row":163,"column":124},"action":"insert","lines":["f"]},{"start":{"row":163,"column":124},"end":{"row":163,"column":125},"action":"insert","lines":["i"]},{"start":{"row":163,"column":125},"end":{"row":163,"column":126},"action":"insert","lines":["c"]},{"start":{"row":163,"column":126},"end":{"row":163,"column":127},"action":"insert","lines":["a"]},{"start":{"row":163,"column":127},"end":{"row":163,"column":128},"action":"insert","lines":["r"]},{"start":{"row":163,"column":128},"end":{"row":163,"column":129},"action":"insert","lines":["l"]},{"start":{"row":163,"column":129},"end":{"row":163,"column":130},"action":"insert","lines":["o"]}],[{"start":{"row":163,"column":119},"end":{"row":163,"column":130},"action":"remove","lines":["verificarlo"],"id":520}],[{"start":{"row":163,"column":119},"end":{"row":163,"column":120},"action":"insert","lines":["m"],"id":521},{"start":{"row":163,"column":120},"end":{"row":163,"column":121},"action":"insert","lines":["e"]},{"start":{"row":163,"column":121},"end":{"row":163,"column":122},"action":"insert","lines":["j"]},{"start":{"row":163,"column":122},"end":{"row":163,"column":123},"action":"insert","lines":["o"]},{"start":{"row":163,"column":123},"end":{"row":163,"column":124},"action":"insert","lines":["r"]},{"start":{"row":163,"column":124},"end":{"row":163,"column":125},"action":"insert","lines":["a"]},{"start":{"row":163,"column":125},"end":{"row":163,"column":126},"action":"insert","lines":["r"]},{"start":{"row":163,"column":126},"end":{"row":163,"column":127},"action":"insert","lines":["l"]},{"start":{"row":163,"column":127},"end":{"row":163,"column":128},"action":"insert","lines":["o"]}],[{"start":{"row":3,"column":0},"end":{"row":5,"column":16},"action":"insert","lines":["using QRCoder;","using System.Drawing;","using System.IO;"],"id":523}],[{"start":{"row":203,"column":0},"end":{"row":204,"column":0},"action":"insert","lines":["",""],"id":524},{"start":{"row":204,"column":0},"end":{"row":205,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":204,"column":0},"end":{"row":238,"column":0},"action":"insert","lines":["using QRCoder;","using System.Drawing;","using System.IO;","","app.MapGet(\"/usuario/{id}/qr\", async (ApiDbContext db, int id, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","    var user = await db.usuarios.FindAsync(id);","","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    // Prepara datos seguros","    var data = new","    {","        id = user.id,","        nombre = protector.Unprotect(user.nombre),","        correo = protector.Unprotect(user.correo),","        tipo_usuario = protector.Unprotect(user.tipo_usuario ?? \"JOVEN\")","    };","","    string jsonData = System.Text.Json.JsonSerializer.Serialize(data);","","    // Generar QR","    using var qrGenerator = new QRCodeGenerator();","    var qrData = qrGenerator.CreateQrCode(jsonData, QRCodeGenerator.ECCLevel.Q);","    var qrCode = new QRCode(qrData);","","    using var qrImage = qrCode.GetGraphic(20);","    using var ms = new MemoryStream();","    qrImage.Save(ms, System.Drawing.Imaging.ImageFormat.Png);","","    return Results.File(ms.ToArray(), \"image/png\");","});",""],"id":525}],[{"start":{"row":206,"column":16},"end":{"row":207,"column":0},"action":"insert","lines":["",""],"id":526},{"start":{"row":207,"column":0},"end":{"row":208,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":209,"column":0},"end":{"row":209,"column":1},"action":"insert","lines":["/"],"id":527},{"start":{"row":209,"column":1},"end":{"row":209,"column":2},"action":"insert","lines":["/"]},{"start":{"row":209,"column":2},"end":{"row":209,"column":3},"action":"insert","lines":["P"]},{"start":{"row":209,"column":3},"end":{"row":209,"column":4},"action":"insert","lines":["r"]},{"start":{"row":209,"column":4},"end":{"row":209,"column":5},"action":"insert","lines":["o"]},{"start":{"row":209,"column":5},"end":{"row":209,"column":6},"action":"insert","lines":["b"]},{"start":{"row":209,"column":6},"end":{"row":209,"column":7},"action":"insert","lines":["a"]},{"start":{"row":209,"column":7},"end":{"row":209,"column":8},"action":"insert","lines":["n"]},{"start":{"row":209,"column":8},"end":{"row":209,"column":9},"action":"insert","lines":["d"]},{"start":{"row":209,"column":9},"end":{"row":209,"column":10},"action":"insert","lines":["o"]}],[{"start":{"row":209,"column":10},"end":{"row":209,"column":11},"action":"insert","lines":[" "],"id":528}],[{"start":{"row":209,"column":11},"end":{"row":209,"column":12},"action":"insert","lines":["g"],"id":529},{"start":{"row":209,"column":12},"end":{"row":209,"column":13},"action":"insert","lines":["e"]},{"start":{"row":209,"column":13},"end":{"row":209,"column":14},"action":"insert","lines":["n"]},{"start":{"row":209,"column":14},"end":{"row":209,"column":15},"action":"insert","lines":["e"]},{"start":{"row":209,"column":15},"end":{"row":209,"column":16},"action":"insert","lines":["r"]},{"start":{"row":209,"column":16},"end":{"row":209,"column":17},"action":"insert","lines":["a"]},{"start":{"row":209,"column":17},"end":{"row":209,"column":18},"action":"insert","lines":["d"]},{"start":{"row":209,"column":18},"end":{"row":209,"column":19},"action":"insert","lines":["o"]},{"start":{"row":209,"column":19},"end":{"row":209,"column":20},"action":"insert","lines":["r"]}],[{"start":{"row":209,"column":20},"end":{"row":209,"column":21},"action":"insert","lines":[" "],"id":530},{"start":{"row":209,"column":21},"end":{"row":209,"column":22},"action":"insert","lines":["d"]},{"start":{"row":209,"column":22},"end":{"row":209,"column":23},"action":"insert","lines":["e"]}],[{"start":{"row":209,"column":23},"end":{"row":209,"column":24},"action":"insert","lines":[" "],"id":531},{"start":{"row":209,"column":24},"end":{"row":209,"column":25},"action":"insert","lines":["Q"]},{"start":{"row":209,"column":25},"end":{"row":209,"column":26},"action":"insert","lines":["R"]}],[{"start":{"row":218,"column":0},"end":{"row":219,"column":0},"action":"remove","lines":["    // Prepara datos seguros",""],"id":532}],[{"start":{"row":203,"column":0},"end":{"row":207,"column":0},"action":"remove","lines":["","using QRCoder;","using System.Drawing;","using System.IO;",""],"id":533},{"start":{"row":202,"column":31},"end":{"row":203,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":3,"column":14},"end":{"row":4,"column":0},"action":"insert","lines":["",""],"id":534}],[{"start":{"row":3,"column":14},"end":{"row":4,"column":0},"action":"remove","lines":["",""],"id":536}],[{"start":{"row":205,"column":0},"end":{"row":233,"column":3},"action":"remove","lines":["app.MapGet(\"/usuario/{id}/qr\", async (ApiDbContext db, int id, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","    var user = await db.usuarios.FindAsync(id);","","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    var data = new","    {","        id = user.id,","        nombre = protector.Unprotect(user.nombre),","        correo = protector.Unprotect(user.correo),","        tipo_usuario = protector.Unprotect(user.tipo_usuario ?? \"JOVEN\")","    };","","    string jsonData = System.Text.Json.JsonSerializer.Serialize(data);","","    // Generar QR","    using var qrGenerator = new QRCodeGenerator();","    var qrData = qrGenerator.CreateQrCode(jsonData, QRCodeGenerator.ECCLevel.Q);","    var qrCode = new QRCode(qrData);","","    using var qrImage = qrCode.GetGraphic(20);","    using var ms = new MemoryStream();","    qrImage.Save(ms, System.Drawing.Imaging.ImageFormat.Png);","","    return Results.File(ms.ToArray(), \"image/png\");","});"],"id":537}],[{"start":{"row":205,"column":0},"end":{"row":231,"column":0},"action":"insert","lines":["app.MapGet(\"/usuario/{id}/qr\", async (ApiDbContext db, int id, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","    var user = await db.usuarios.FindAsync(id);","","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    var data = new","    {","        id = user.id,","        nombre = protector.Unprotect(user.nombre),","        correo = protector.Unprotect(user.correo),","        tipo_usuario = protector.Unprotect(user.tipo_usuario ?? \"JOVEN\")","    };","","    string jsonData = System.Text.Json.JsonSerializer.Serialize(data);","","    using var qrGenerator = new QRCodeGenerator();","    var qrData = qrGenerator.CreateQrCode(jsonData, QRCodeGenerator.ECCLevel.Q);","    var qrCode = new SvgQRCode(qrData);","","    string svgImage = qrCode.GetGraphic(5); // Genera SVG en string","","    return Results.Content(svgImage, \"image/svg+xml\");","});",""],"id":538}],[{"start":{"row":205,"column":0},"end":{"row":231,"column":0},"action":"remove","lines":["app.MapGet(\"/usuario/{id}/qr\", async (ApiDbContext db, int id, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","    var user = await db.usuarios.FindAsync(id);","","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    var data = new","    {","        id = user.id,","        nombre = protector.Unprotect(user.nombre),","        correo = protector.Unprotect(user.correo),","        tipo_usuario = protector.Unprotect(user.tipo_usuario ?? \"JOVEN\")","    };","","    string jsonData = System.Text.Json.JsonSerializer.Serialize(data);","","    using var qrGenerator = new QRCodeGenerator();","    var qrData = qrGenerator.CreateQrCode(jsonData, QRCodeGenerator.ECCLevel.Q);","    var qrCode = new SvgQRCode(qrData);","","    string svgImage = qrCode.GetGraphic(5); // Genera SVG en string","","    return Results.Content(svgImage, \"image/svg+xml\");","});",""],"id":539},{"start":{"row":205,"column":0},"end":{"row":231,"column":0},"action":"insert","lines":["app.MapGet(\"/usuario/{id}/qr\", async (ApiDbContext db, int id, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","    var user = await db.usuarios.FindAsync(id);","","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    var data = new","    {","        id = user.id,","        nombre = SafeUnprotect(protector, user.nombre),","        correo = SafeUnprotect(protector, user.correo),","        tipo_usuario = SafeUnprotect(protector, user.tipo_usuario ?? \"JOVEN\")","    };","","    string jsonData = System.Text.Json.JsonSerializer.Serialize(data);","","    using var qrGenerator = new QRCodeGenerator();","    var qrData = qrGenerator.CreateQrCode(jsonData, QRCodeGenerator.ECCLevel.Q);","    var qrCode = new SvgQRCode(qrData);","","    string svgImage = qrCode.GetGraphic(5); ","","    return Results.Content(svgImage, \"image/svg+xml\");","});",""]}],[{"start":{"row":218,"column":77},"end":{"row":219,"column":0},"action":"insert","lines":["",""],"id":540},{"start":{"row":219,"column":0},"end":{"row":219,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":219,"column":8},"end":{"row":219,"column":39},"action":"insert","lines":["esta_activo = user.esta_activo,"],"id":541}],[{"start":{"row":219,"column":22},"end":{"row":219,"column":35},"action":"insert","lines":["SafeUnprotect"],"id":542}],[{"start":{"row":219,"column":35},"end":{"row":219,"column":36},"action":"insert","lines":["("],"id":543}],[{"start":{"row":219,"column":52},"end":{"row":219,"column":53},"action":"remove","lines":[","],"id":544}],[{"start":{"row":219,"column":52},"end":{"row":219,"column":53},"action":"insert","lines":[")"],"id":545}],[{"start":{"row":219,"column":36},"end":{"row":219,"column":37},"action":"insert","lines":["p"],"id":546},{"start":{"row":219,"column":37},"end":{"row":219,"column":38},"action":"insert","lines":["r"]},{"start":{"row":219,"column":38},"end":{"row":219,"column":39},"action":"insert","lines":["o"]}],[{"start":{"row":219,"column":36},"end":{"row":219,"column":39},"action":"remove","lines":["pro"],"id":547},{"start":{"row":219,"column":36},"end":{"row":219,"column":45},"action":"insert","lines":["protector"]}],[{"start":{"row":219,"column":45},"end":{"row":219,"column":46},"action":"insert","lines":[","],"id":548}],[{"start":{"row":219,"column":46},"end":{"row":219,"column":47},"action":"insert","lines":[" "],"id":549}],[{"start":{"row":0,"column":0},"end":{"row":236,"column":0},"action":"remove","lines":["using Microsoft.EntityFrameworkCore;","using Isopoh.Cryptography.Argon2;","using Microsoft.AspNetCore.DataProtection;","using QRCoder;","using System.Drawing;","using System.IO;","var builder = WebApplication.CreateBuilder(args);","","// --------------------- Configuración de servicios ---------------------","","// Conexión a MySQL","builder.Services.AddDbContext<ApiDbContext>(options =>","    options.UseMySql(","        builder.Configuration.GetConnectionString(\"DefaultConnection\"),","        new MySqlServerVersion(new Version(8, 0, 36))","    ));","","// Swagger","builder.Services.AddEndpointsApiExplorer();","builder.Services.AddSwaggerGen();","","// Data Protection","builder.Services.AddDataProtection()","    .SetApplicationName(\"AppBeneficios\");","","var app = builder.Build();","","// --------------------- Middleware ---------------------","if (app.Environment.IsDevelopment())","{","    app.UseSwagger();","    app.UseSwaggerUI();","}","","// --------------------- Helpers ---------------------","static string SafeUnprotect(IDataProtector protector, string encrypted)","{","    if (string.IsNullOrEmpty(encrypted)) return encrypted;","    try","    {","        return protector.Unprotect(encrypted);","    }","    catch","    {","        return encrypted; // ya valio xd","    }","}","","// --------------------- Endpoints ---------------------","","app.MapGet(\"/\", () => Results.Redirect(\"/inicio\"));","app.MapGet(\"/inicio\", () => \"¡Bienvenido a Inicio!\");","","// --------------------- Obtener todos los usuarios ---------------------","app.MapGet(\"/usuarios\", async (ApiDbContext db, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","","    // Traer a memoria primero","    var usuariosEntities = await db.usuarios.ToListAsync();","","    var usuarios = usuariosEntities.Select(u => new UsersDto","    {","        id = u.id,","        correo = SafeUnprotect(protector, u.correo),","        nombre = SafeUnprotect(protector, u.nombre),","        apellidos = SafeUnprotect(protector, u.apellidos),","        telefono = SafeUnprotect(protector, u.telefono ?? \"\"),","        curp = SafeUnprotect(protector, u.curp),","        direccion = SafeUnprotect(protector, u.direccion ?? \"\"),","        tipo_usuario = SafeUnprotect(protector, u.tipo_usuario ?? \"JOVEN\"),","        esta_activo = u.esta_activo,","        creado_en = u.creado_en","    }).ToList();","","    return Results.Ok(usuarios);","}).WithName(\"ObtenerUsuarios\");","","// --------------------- Obtener usuario por ID ---------------------","app.MapGet(\"/usuario/{id}\", async (ApiDbContext db, int id, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","","    var user = await db.usuarios.FindAsync(id);","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    var dto = new UsersDto","    {","        id = user.id,","        correo = SafeUnprotect(protector, user.correo),","        nombre = SafeUnprotect(protector, user.nombre),","        apellidos = SafeUnprotect(protector, user.apellidos),","        telefono = SafeUnprotect(protector, user.telefono ?? \"\"),","        curp = SafeUnprotect(protector, user.curp),","        direccion = SafeUnprotect(protector, user.direccion ?? \"\"),","        tipo_usuario = SafeUnprotect(protector, user.tipo_usuario ?? \"JOVEN\"),","        esta_activo = user.esta_activo,","        creado_en = user.creado_en","    };","","    return Results.Ok(dto);","}).WithName(\"ObtenerUsuarioPorId\");","","// --------------------- Crear Usuario ---------------------","app.MapPost(\"/usuario\", async (ApiDbContext db, UsersCreateDto dto, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","","    // Validaciones","    /* Aun tengo que considerar valores para esto","    if (string.IsNullOrWhiteSpace(dto.nombre) || string.IsNullOrWhiteSpace(dto.curp))","        return Results.BadRequest(new { mensaje = \"Nombre y CURP son obligatorios\" });","","    if (await db.usuarios.AnyAsync(u => u.correo == dto.correo))","        return Results.BadRequest(new { mensaje = \"Email ya registrado\" });","    ","    if (await db.usuarios.AnyAsync(u => u.telefono == dto.telefono))","        return Results.BadRequest(new { mensaje = \"telefono ya registrado\" });","","    if (await db.usuarios.AnyAsync(u => u.curp == dto.curp))","        return Results.BadRequest(new { mensaje = \"CURP ya registrado\" }); */","","    // Hash de contraseña","    string passwordHash = Argon2.Hash(dto.contrasena);","","    var user = new Users","    {","        correo = protector.Protect(dto.correo),","        hash_contrasena = passwordHash,","        nombre = protector.Protect(dto.nombre),","        apellidos = protector.Protect(dto.apellidos ?? \"\"),","        telefono = protector.Protect(dto.telefono ?? \"\"),","        curp = protector.Protect(dto.curp),","        direccion = protector.Protect(dto.direccion ?? \"\"),","        tipo_usuario = string.IsNullOrWhiteSpace(dto.tipo_usuario) ? \"JOVEN\" : dto.tipo_usuario,","        esta_activo = true","    };","","    db.usuarios.Add(user);","    await db.SaveChangesAsync();","","    // Devolver datos desencriptados","    var resultDto = new UsersDto","    {","        id = user.id,","        correo = dto.correo,","        nombre = dto.nombre,","        apellidos = dto.apellidos ?? \"\",","        telefono = dto.telefono ?? \"\",","        curp = dto.curp,","        direccion = dto.direccion ?? \"\",","        tipo_usuario = dto.tipo_usuario ?? \"JOVEN\",","        esta_activo = user.esta_activo,","        creado_en = user.creado_en","    };","","    return Results.Ok(resultDto);","}).WithName(\"CrearUsuario\");","","// --------------------- Login ---------------------","app.MapPost(\"/login\", async (ApiDbContext db, LoginDto login, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","","    var usuarios = await db.usuarios.ToListAsync(); // Trae todo a memoria, Esto lo considero poco optimo asi que debo mejorarlo","","    var user = usuarios.FirstOrDefault(u =>","        SafeUnprotect(protector, u.correo).Equals(login.correo, StringComparison.OrdinalIgnoreCase)","    );","    ","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    if (!Argon2.Verify(user.hash_contrasena, login.contrasena))","        return Results.BadRequest(new { mensaje = \"Contraseña incorrecta\" });","","    var result = new","    {","        id = user.id,","        correo = SafeUnprotect(protector, user.correo),","        nombre = SafeUnprotect(protector, user.nombre),","        apellidos = SafeUnprotect(protector, user.apellidos ?? \"\"),","        telefono = SafeUnprotect(protector, user.telefono ?? \"\"),","        curp = SafeUnprotect(protector, user.curp),","        direccion = SafeUnprotect(protector, user.direccion ?? \"\"),","        tipo_usuario = user.tipo_usuario","    };","","    return Results.Ok(result);","}).WithName(\"Login\");","","// --------------------- Eliminar Usuario ---------------------","app.MapDelete(\"/usuario/{id:int}\", async (ApiDbContext db, int id) =>","{","    var usuario = await db.usuarios.FindAsync(id);","    if (usuario == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    db.usuarios.Remove(usuario);","    await db.SaveChangesAsync();","    return Results.Ok(new { mensaje = $\"Usuario eliminado correctamente\" });","}).WithName(\"EliminarUsuario\");","","//Probando generador de QR","app.MapGet(\"/usuario/{id}/qr\", async (ApiDbContext db, int id, IDataProtectionProvider provider) =>","{","    var protector = provider.CreateProtector(\"UserData\");","    var user = await db.usuarios.FindAsync(id);","","    if (user == null)","        return Results.NotFound(new { mensaje = \"Usuario no encontrado\" });","","    var data = new","    {","        id = user.id,","        nombre = SafeUnprotect(protector, user.nombre),","        correo = SafeUnprotect(protector, user.correo),","        tipo_usuario = SafeUnprotect(protector, user.tipo_usuario ?? \"JOVEN\")","        esta_activo = SafeUnprotect(protector, user.esta_activo)","    };","","    string jsonData = System.Text.Json.JsonSerializer.Serialize(data);","","    using var qrGenerator = new QRCodeGenerator();","    var qrData = qrGenerator.CreateQrCode(jsonData, QRCodeGenerator.ECCLevel.Q);","    var qrCode = new SvgQRCode(qrData);","","    string svgImage = qrCode.GetGraphic(5); ","","    return Results.Content(svgImage, \"image/svg+xml\");","});","","","","app.Run();",""],"id":550},{"start":{"row":0,"column":0},"end":{"row":19,"column":0},"action":"insert","lines":["using Backend.Servicios;","using Backend.Endpoints;","","var builder = WebApplication.CreateBuilder(args);","","builder.Services.AddScoped<IServicioCifrado, ServicioCifrado>();","builder.Services.AddScoped<IServicioAutenticacion, ServicioAutenticacion>();","","var app = builder.Build();","","if (app.Environment.IsDevelopment())","{","    app.UseSwagger();","    app.UseSwaggerUI();","}","","app.MapearEndpointsAutenticacion();","","app.Run();",""]}],[{"start":{"row":0,"column":0},"end":{"row":18,"column":10},"action":"remove","lines":["using Backend.Servicios;","using Backend.Endpoints;","","var builder = WebApplication.CreateBuilder(args);","","builder.Services.AddScoped<IServicioCifrado, ServicioCifrado>();","builder.Services.AddScoped<IServicioAutenticacion, ServicioAutenticacion>();","","var app = builder.Build();","","if (app.Environment.IsDevelopment())","{","    app.UseSwagger();","    app.UseSwaggerUI();","}","","app.MapearEndpointsAutenticacion();","","app.Run();"],"id":551},{"start":{"row":0,"column":0},"end":{"row":28,"column":0},"action":"insert","lines":["using Backend.Servicios;","using Backend.Modelos.Usuario;","using Microsoft.EntityFrameworkCore;","using Microsoft.AspNetCore.DataProtection;","","var builder = WebApplication.CreateBuilder(args);","","// ---------------------------","// Configurar DbContext","// ---------------------------","builder.Services.AddDbContext<ApiDbContext>(options =>","    options.UseSqlServer(builder.Configuration.GetConnectionString(\"DefaultConnection\")));","","// ---------------------------","// Configurar servicios","// ---------------------------","builder.Services.AddScoped<IServicioCifrado, ServicioCifrado>();","builder.Services.AddScoped<IServicioAutenticacion, ServicioAutenticacion>();","","// Configuración de DataProtection para ServicioCifrado","builder.Services.AddDataProtection();","","var app = builder.Build();","","// Mapear endpoints o usar controllers","app.MapGet(\"/\", () => \"API funcionando\");","","app.Run();",""]}],[{"start":{"row":0,"column":0},"end":{"row":28,"column":0},"action":"remove","lines":["using Backend.Servicios;","using Backend.Modelos.Usuario;","using Microsoft.EntityFrameworkCore;","using Microsoft.AspNetCore.DataProtection;","","var builder = WebApplication.CreateBuilder(args);","","// ---------------------------","// Configurar DbContext","// ---------------------------","builder.Services.AddDbContext<ApiDbContext>(options =>","    options.UseSqlServer(builder.Configuration.GetConnectionString(\"DefaultConnection\")));","","// ---------------------------","// Configurar servicios","// ---------------------------","builder.Services.AddScoped<IServicioCifrado, ServicioCifrado>();","builder.Services.AddScoped<IServicioAutenticacion, ServicioAutenticacion>();","","// Configuración de DataProtection para ServicioCifrado","builder.Services.AddDataProtection();","","var app = builder.Build();","","// Mapear endpoints o usar controllers","app.MapGet(\"/\", () => \"API funcionando\");","","app.Run();",""],"id":555},{"start":{"row":0,"column":0},"end":{"row":28,"column":0},"action":"insert","lines":["using Backend.Servicios;","using Backend.Modelos.Usuario;","using Backend.Ayudantes;","using Microsoft.EntityFrameworkCore;","using Microsoft.AspNetCore.DataProtection;","","var builder = WebApplication.CreateBuilder(args);","","// DbContext","builder.Services.AddDbContext<ApiDbContext>(options =>","    options.UseSqlServer(\"Server=tu_servidor;Database=tu_db;User Id=usuario;Password=contra;\"));","","// Agregar Data Protection","builder.Services.AddDataProtection();","","// Registrar servicios","builder.Services.AddScoped<IServicioCifrado, ServicioCifrado>();","builder.Services.AddScoped<IServicioAutenticacion, ServicioAutenticacion>();","","var app = builder.Build();","","// Mapear endpoints","app.MapearEndpointsAutenticacion();","","// Escuchar en todas las IPs externas y puerto 8080","app.Urls.Add(\"http://0.0.0.0:8080\");","","app.Run();",""]}],[{"start":{"row":2,"column":24},"end":{"row":3,"column":0},"action":"insert","lines":["",""],"id":556}],[{"start":{"row":3,"column":0},"end":{"row":4,"column":0},"action":"insert","lines":["using Backend.Endpoints;",""],"id":557}],[{"start":{"row":11,"column":0},"end":{"row":13,"column":0},"action":"remove","lines":["builder.Services.AddDbContext<ApiDbContext>(options =>","    options.UseSqlServer(\"Server=tu_servidor;Database=tu_db;User Id=usuario;Password=contra;\"));",""],"id":558},{"start":{"row":11,"column":0},"end":{"row":16,"column":0},"action":"insert","lines":["builder.Services.AddDbContext<ApiDbContext>(options =>","    options.UseMySql(","        builder.Configuration.GetConnectionString(\"DefaultConnection\"),","        new MySqlServerVersion(new Version(8, 0, 36))","    ));",""]}],[{"start":{"row":2,"column":0},"end":{"row":3,"column":0},"action":"remove","lines":["using Backend.Ayudantes;",""],"id":559}],[{"start":{"row":8,"column":0},"end":{"row":9,"column":0},"action":"insert","lines":["",""],"id":560},{"start":{"row":9,"column":0},"end":{"row":10,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":9,"column":0},"end":{"row":13,"column":1},"action":"insert","lines":["if (app.Environment.IsDevelopment())","{","    app.UseSwagger();","    app.UseSwaggerUI();","}"],"id":561}],[{"start":{"row":8,"column":0},"end":{"row":9,"column":0},"action":"insert","lines":["",""],"id":562},{"start":{"row":9,"column":0},"end":{"row":10,"column":0},"action":"insert","lines":["",""]},{"start":{"row":10,"column":0},"end":{"row":10,"column":1},"action":"insert","lines":["/"]},{"start":{"row":10,"column":1},"end":{"row":10,"column":2},"action":"insert","lines":["/"]}],[{"start":{"row":10,"column":2},"end":{"row":10,"column":3},"action":"insert","lines":[" "],"id":563},{"start":{"row":10,"column":3},"end":{"row":10,"column":4},"action":"insert","lines":["M"]},{"start":{"row":10,"column":4},"end":{"row":10,"column":5},"action":"insert","lines":["a"]},{"start":{"row":10,"column":5},"end":{"row":10,"column":6},"action":"insert","lines":["n"]},{"start":{"row":10,"column":6},"end":{"row":10,"column":7},"action":"insert","lines":["t"]},{"start":{"row":10,"column":7},"end":{"row":10,"column":8},"action":"insert","lines":["i"]},{"start":{"row":10,"column":8},"end":{"row":10,"column":9},"action":"insert","lines":["e"]}],[{"start":{"row":10,"column":8},"end":{"row":10,"column":9},"action":"remove","lines":["e"],"id":564},{"start":{"row":10,"column":7},"end":{"row":10,"column":8},"action":"remove","lines":["i"]},{"start":{"row":10,"column":6},"end":{"row":10,"column":7},"action":"remove","lines":["t"]},{"start":{"row":10,"column":5},"end":{"row":10,"column":6},"action":"remove","lines":["n"]},{"start":{"row":10,"column":4},"end":{"row":10,"column":5},"action":"remove","lines":["a"]}],[{"start":{"row":10,"column":3},"end":{"row":10,"column":4},"action":"remove","lines":["M"],"id":565}],[{"start":{"row":10,"column":3},"end":{"row":10,"column":4},"action":"insert","lines":["c"],"id":566},{"start":{"row":10,"column":4},"end":{"row":10,"column":5},"action":"insert","lines":["o"]},{"start":{"row":10,"column":5},"end":{"row":10,"column":6},"action":"insert","lines":["s"]},{"start":{"row":10,"column":6},"end":{"row":10,"column":7},"action":"insert","lines":["a"]}],[{"start":{"row":10,"column":7},"end":{"row":10,"column":8},"action":"insert","lines":[" "],"id":567},{"start":{"row":10,"column":8},"end":{"row":10,"column":9},"action":"insert","lines":["d"]},{"start":{"row":10,"column":9},"end":{"row":10,"column":10},"action":"insert","lines":["e"]},{"start":{"row":10,"column":10},"end":{"row":10,"column":11},"action":"insert","lines":["l"]}],[{"start":{"row":10,"column":11},"end":{"row":10,"column":12},"action":"insert","lines":[" "],"id":568},{"start":{"row":10,"column":12},"end":{"row":10,"column":13},"action":"insert","lines":["s"]},{"start":{"row":10,"column":13},"end":{"row":10,"column":14},"action":"insert","lines":["w"]},{"start":{"row":10,"column":14},"end":{"row":10,"column":15},"action":"insert","lines":["a"]},{"start":{"row":10,"column":15},"end":{"row":10,"column":16},"action":"insert","lines":["g"]},{"start":{"row":10,"column":16},"end":{"row":10,"column":17},"action":"insert","lines":["g"]},{"start":{"row":10,"column":17},"end":{"row":10,"column":18},"action":"insert","lines":["e"]},{"start":{"row":10,"column":18},"end":{"row":10,"column":19},"action":"insert","lines":["r"]}],[{"start":{"row":15,"column":1},"end":{"row":16,"column":0},"action":"insert","lines":["",""],"id":569},{"start":{"row":16,"column":0},"end":{"row":17,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":17,"column":0},"end":{"row":19,"column":33},"action":"insert","lines":["// Swagger para documentación de API","builder.Services.AddEndpointsApiExplorer();","builder.Services.AddSwaggerGen();"],"id":570}],[{"start":{"row":17,"column":0},"end":{"row":19,"column":33},"action":"remove","lines":["// Swagger para documentación de API","builder.Services.AddEndpointsApiExplorer();","builder.Services.AddSwaggerGen();"],"id":571}],[{"start":{"row":16,"column":0},"end":{"row":17,"column":0},"action":"remove","lines":["",""],"id":572},{"start":{"row":15,"column":1},"end":{"row":16,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":9,"column":0},"end":{"row":10,"column":0},"action":"insert","lines":["",""],"id":573},{"start":{"row":10,"column":0},"end":{"row":11,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":10,"column":0},"end":{"row":12,"column":33},"action":"insert","lines":["// Swagger para documentación de API","builder.Services.AddEndpointsApiExplorer();","builder.Services.AddSwaggerGen();"],"id":574}],[{"start":{"row":14,"column":0},"end":{"row":19,"column":1},"action":"remove","lines":["// cosa del swagger","if (app.Environment.IsDevelopment())","{","    app.UseSwagger();","    app.UseSwaggerUI();","}"],"id":575}],[{"start":{"row":13,"column":0},"end":{"row":14,"column":0},"action":"remove","lines":["",""],"id":576},{"start":{"row":12,"column":33},"end":{"row":13,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":28,"column":26},"end":{"row":29,"column":0},"action":"insert","lines":["",""],"id":577},{"start":{"row":29,"column":0},"end":{"row":30,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":30,"column":0},"end":{"row":35,"column":1},"action":"insert","lines":["// cosa del swagger","if (app.Environment.IsDevelopment())","{","    app.UseSwagger();","    app.UseSwaggerUI();","}"],"id":578}]]},"ace":{"folds":[],"scrolltop":144.59999999999997,"scrollleft":0,"selection":{"start":{"row":42,"column":0},"end":{"row":42,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1759526087929,"hash":"f058da28515f12cb72755824f129cf41773dd19e"}